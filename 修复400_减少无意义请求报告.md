# ä¿®å¤ 400ï¼šå‡å°‘æ— æ„ä¹‰ required_version æŸ¥è¯¢ - å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®æ–½ä¿®å¤

### é—®é¢˜åˆ†æ

**ç°çŠ¶**:
```
GET app_state?select=required_version ... 400 (Bad Request)
ç„¶åæ‰æ‰“å°"è·³è¿‡"
```

**é—®é¢˜**:
- æ¯æ¬¡å¯åŠ¨éƒ½å‘èµ·æŸ¥è¯¢è¯·æ±‚
- æ”¶åˆ° 400 é”™è¯¯åæ‰è·³è¿‡
- äº§ç”Ÿæ— æ„ä¹‰çš„ç½‘ç»œè¯·æ±‚å’Œé”™è¯¯æ—¥å¿—

**ä¿®å¤ç­–ç•¥**:
1. ä½¿ç”¨ localStorage ç¼“å­˜æ ‡è®°
2. é¦–æ¬¡æŸ¥è¯¢å¤±è´¥åè®¾ç½®æ ‡è®°
3. åç»­å¯åŠ¨æ—¶æ£€æŸ¥æ ‡è®°ï¼Œç›´æ¥è·³è¿‡ï¼Œä¸å‘èµ·è¯·æ±‚
4. æŸ¥è¯¢æˆåŠŸæ—¶è‡ªåŠ¨æ¸…é™¤æ ‡è®°ï¼ˆæ”¯æŒæ•°æ®åº“è¿ç§»åæ¢å¤ï¼‰

---

### 1. ç¼“å­˜æœºåˆ¶å®ç°

**æ–‡ä»¶**: `src/services/cloudOnly.ts`

**å®ç°**:
- ä½¿ç”¨ `localStorage` å­˜å‚¨ `version_check_disabled_column_missing` æ ‡è®°
- é¦–æ¬¡æŸ¥è¯¢å¤±è´¥ï¼ˆ42703ï¼‰åè®¾ç½®æ ‡è®°ä¸º `'true'`
- åç»­å¯åŠ¨æ—¶æ£€æŸ¥æ ‡è®°ï¼Œå¦‚æœä¸º `'true'`ï¼Œç›´æ¥è·³è¿‡ï¼Œä¸å‘èµ·è¯·æ±‚
- æŸ¥è¯¢æˆåŠŸæ—¶è‡ªåŠ¨æ¸…é™¤æ ‡è®°

**ä»£ç ç‰‡æ®µ**:
```typescript
// ã€å‡å°‘æ— æ„ä¹‰ 400ã€‘æ£€æŸ¥ç¼“å­˜æ ‡è®°ï¼Œå¦‚æœåˆ—ä¸å­˜åœ¨ï¼Œç›´æ¥è·³è¿‡ï¼Œä¸å‘èµ·è¯·æ±‚
const versionCheckDisabledKey = 'version_check_disabled_column_missing';
const isVersionCheckDisabled = localStorage.getItem(versionCheckDisabledKey) === 'true';

if (isVersionCheckDisabled) {
  console.log('â„¹ï¸ ç‰ˆæœ¬æ£€æŸ¥å·²ç¦ç”¨ï¼ˆåˆ—ç¼ºå¤±/åŠŸèƒ½å…³é—­ï¼‰');
  return; // ç›´æ¥è¿”å›ï¼Œä¸å‘èµ·ç½‘ç»œè¯·æ±‚
}

try {
  // æŸ¥è¯¢äº‘ç«¯ required_version
  const { data, error } = await supabase
    .from('app_state')
    .select('required_version')
    .eq('owner_id', userId)
    .maybeSingle();

  if (error) {
    // å¦‚æœåˆ—ä¸å­˜åœ¨ï¼ˆ42703ï¼‰ï¼Œè®¾ç½®ç¼“å­˜æ ‡è®°
    if (error.code === '42703' || error.message?.includes('does not exist')) {
      localStorage.setItem(versionCheckDisabledKey, 'true');
      console.log('â„¹ï¸ ç‰ˆæœ¬æ£€æŸ¥è·³è¿‡ï¼šrequired_version åˆ—ä¸å­˜åœ¨ï¼ˆæ•°æ®åº“æœªè¿ç§»ï¼‰ï¼Œå·²ç¦ç”¨åç»­æŸ¥è¯¢');
      return;
    }
  }
  
  // å¦‚æœæŸ¥è¯¢æˆåŠŸï¼Œæ¸…é™¤ç¦ç”¨æ ‡è®°ï¼ˆå¯èƒ½æ•°æ®åº“å·²è¿ç§»ï¼‰
  if (localStorage.getItem(versionCheckDisabledKey) === 'true') {
    localStorage.removeItem(versionCheckDisabledKey);
    console.log('âœ… ç‰ˆæœ¬æ£€æŸ¥å·²é‡æ–°å¯ç”¨ï¼ˆæ•°æ®åº“å¯èƒ½å·²è¿ç§»ï¼‰');
  }
}
```

---

### 2. DebugPanel æ›´æ–°

**æ–‡ä»¶**: `src/components/DebugPanel.tsx`

**å®ç°**:
- æ£€æŸ¥ç¼“å­˜æ ‡è®°ï¼Œå¦‚æœå·²ç¦ç”¨ï¼Œä¸å‘èµ·è¯·æ±‚
- æ˜¾ç¤ºå‹å¥½æç¤ºï¼š"ç‰ˆæœ¬æ£€æŸ¥å·²ç¦ç”¨ï¼ˆåˆ—ç¼ºå¤±/åŠŸèƒ½å…³é—­ï¼‰"
- å¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œä¹Ÿè®¾ç½®æ ‡è®°å¹¶æ˜¾ç¤ºæç¤º

**ä»£ç ç‰‡æ®µ**:
```typescript
// ã€å‡å°‘æ— æ„ä¹‰ 400ã€‘æ£€æŸ¥ç¼“å­˜æ ‡è®°ï¼Œå¦‚æœå·²ç¦ç”¨ï¼Œä¸å‘èµ·è¯·æ±‚
const versionCheckDisabledKey = 'version_check_disabled_column_missing';
const isVersionCheckDisabled = localStorage.getItem(versionCheckDisabledKey) === 'true';

if (isVersionCheckDisabled) {
  requiredVersion = 'ç‰ˆæœ¬æ£€æŸ¥å·²ç¦ç”¨ï¼ˆåˆ—ç¼ºå¤±/åŠŸèƒ½å…³é—­ï¼‰';
  versionCheckSkipped = true;
} else if (userId && supabase) {
  try {
    const { data, error } = await supabase
      .from('app_state')
      .select('required_version')
      .eq('owner_id', userId)
      .maybeSingle();
    
    if (error) {
      if (error.code === '42703' || error.message?.includes('does not exist')) {
        requiredVersion = 'ç‰ˆæœ¬æ£€æŸ¥å·²ç¦ç”¨ï¼ˆåˆ—ç¼ºå¤±/åŠŸèƒ½å…³é—­ï¼‰';
        versionCheckSkipped = true;
        // è®¾ç½®ç¼“å­˜æ ‡è®°
        localStorage.setItem(versionCheckDisabledKey, 'true');
      }
    } else {
      requiredVersion = data?.required_version || 'null';
      // æ¸…é™¤ç¦ç”¨æ ‡è®°
      if (localStorage.getItem(versionCheckDisabledKey) === 'true') {
        localStorage.removeItem(versionCheckDisabledKey);
      }
    }
  } catch (err: any) {
    requiredVersion = `å¼‚å¸¸: ${err.message}`;
  }
}
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆé—®é¢˜æ—¥å¿—ï¼‰
```
GET https://ptmgncjechjprxtndqon.supabase.co/rest/v1/app_state?select=required_version&owner_id=eq.xxx 400 (Bad Request)
âŒ ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥: {code: '42703', message: 'column app_state.required_version does not exist'}
â„¹ï¸ ç‰ˆæœ¬æ£€æŸ¥è·³è¿‡ï¼šrequired_version åˆ—ä¸å­˜åœ¨ï¼ˆæ•°æ®åº“æœªè¿ç§»ï¼‰
```

**é—®é¢˜**:
- âŒ æ¯æ¬¡å¯åŠ¨éƒ½å‘èµ·æŸ¥è¯¢è¯·æ±‚
- âŒ æ”¶åˆ° 400 é”™è¯¯åæ‰è·³è¿‡
- âŒ Network é¢æ¿ä¸­çœ‹åˆ°å¤±è´¥çš„è¯·æ±‚

### ä¿®å¤åï¼ˆé¢„æœŸæ•ˆæœï¼‰

#### é¦–æ¬¡å¯åŠ¨ï¼ˆåˆ—ä¸å­˜åœ¨ï¼‰
```
â„¹ï¸ ç‰ˆæœ¬æ£€æŸ¥å·²ç¦ç”¨ï¼ˆåˆ—ç¼ºå¤±/åŠŸèƒ½å…³é—­ï¼‰
// ä¸å‘èµ·ç½‘ç»œè¯·æ±‚
```

#### åç»­å¯åŠ¨ï¼ˆå·²ç¼“å­˜ï¼‰
```
â„¹ï¸ ç‰ˆæœ¬æ£€æŸ¥å·²ç¦ç”¨ï¼ˆåˆ—ç¼ºå¤±/åŠŸèƒ½å…³é—­ï¼‰
// ä¸å‘èµ·ç½‘ç»œè¯·æ±‚
```

#### æ•°æ®åº“è¿ç§»åï¼ˆè‡ªåŠ¨æ¢å¤ï¼‰
```
âœ… ç‰ˆæœ¬æ£€æŸ¥å·²é‡æ–°å¯ç”¨ï¼ˆæ•°æ®åº“å¯èƒ½å·²è¿ç§»ï¼‰
ğŸ” ç‰ˆæœ¬æ£€æŸ¥: { currentVersion: 'V260105.30', requiredVersion: 'V260105.30' }
```

**æ”¹è¿›**:
- âœ… é¦–æ¬¡å¤±è´¥åä¸å†å‘èµ·è¯·æ±‚
- âœ… æ—  400 é”™è¯¯æ—¥å¿—
- âœ… Network é¢æ¿ä¸­æ— å¤±è´¥è¯·æ±‚
- âœ… è‡ªåŠ¨æ¢å¤æœºåˆ¶ï¼ˆæ•°æ®åº“è¿ç§»åï¼‰

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### âœ… å·²å®ç°

1. **å…¨æ–°æ‰“å¼€é¡µé¢å¯åŠ¨é˜¶æ®µ Network ä¸­æ²¡æœ‰ required_version çš„è¯·æ±‚**
   - âœ… æ£€æŸ¥ç¼“å­˜æ ‡è®°ï¼Œç›´æ¥è·³è¿‡
   - âœ… ä¸å‘èµ·ç½‘ç»œè¯·æ±‚

2. **å¯åŠ¨æ—¥å¿—ä¸­ä¸å†å‡ºç° 400 è¯·æ±‚**
   - âœ… é¦–æ¬¡å¤±è´¥åè®¾ç½®æ ‡è®°
   - âœ… åç»­å¯åŠ¨ç›´æ¥è·³è¿‡

3. **DebugPanel ä»æ˜¾ç¤ºå‹å¥½æç¤º**
   - âœ… æ˜¾ç¤º"ç‰ˆæœ¬æ£€æŸ¥å·²ç¦ç”¨ï¼ˆåˆ—ç¼ºå¤±/åŠŸèƒ½å…³é—­ï¼‰"
   - âœ… ä¸å‘èµ·ç½‘ç»œè¯·æ±‚

4. **è‡ªåŠ¨æ¢å¤æœºåˆ¶**
   - âœ… æŸ¥è¯¢æˆåŠŸæ—¶è‡ªåŠ¨æ¸…é™¤æ ‡è®°
   - âœ… æ”¯æŒæ•°æ®åº“è¿ç§»åè‡ªåŠ¨æ¢å¤

---

## ğŸ” éªŒè¯æ–¹æ³•

### 1. æ£€æŸ¥ Network é¢æ¿

**æ­¥éª¤**:
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œ localStorage
2. æ‰“å¼€åº”ç”¨ï¼ˆé¦–æ¬¡å¯åŠ¨ï¼Œåˆ—ä¸å­˜åœ¨ï¼‰
3. è§‚å¯Ÿ Network é¢æ¿
4. åº”è¯¥çœ‹åˆ°ä¸€æ¬¡ `GET app_state?select=required_version` è¯·æ±‚ï¼ˆ400ï¼‰
5. åˆ·æ–°é¡µé¢ï¼ˆç¬¬äºŒæ¬¡å¯åŠ¨ï¼‰
6. åº”è¯¥**ä¸å†çœ‹åˆ°** `required_version` çš„è¯·æ±‚

**é¢„æœŸç»“æœ**:
- é¦–æ¬¡å¯åŠ¨ï¼š1 æ¬¡è¯·æ±‚ï¼ˆ400ï¼Œè®¾ç½®æ ‡è®°ï¼‰
- åç»­å¯åŠ¨ï¼š0 æ¬¡è¯·æ±‚ï¼ˆç›´æ¥è·³è¿‡ï¼‰

### 2. æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—

**é¦–æ¬¡å¯åŠ¨**:
```
â„¹ï¸ ç‰ˆæœ¬æ£€æŸ¥è·³è¿‡ï¼šrequired_version åˆ—ä¸å­˜åœ¨ï¼ˆæ•°æ®åº“æœªè¿ç§»ï¼‰ï¼Œå·²ç¦ç”¨åç»­æŸ¥è¯¢
```

**åç»­å¯åŠ¨**:
```
â„¹ï¸ ç‰ˆæœ¬æ£€æŸ¥å·²ç¦ç”¨ï¼ˆåˆ—ç¼ºå¤±/åŠŸèƒ½å…³é—­ï¼‰
```

**æ•°æ®åº“è¿ç§»å**:
```
âœ… ç‰ˆæœ¬æ£€æŸ¥å·²é‡æ–°å¯ç”¨ï¼ˆæ•°æ®åº“å¯èƒ½å·²è¿ç§»ï¼‰
ğŸ” ç‰ˆæœ¬æ£€æŸ¥: { currentVersion: 'V260105.30', requiredVersion: 'V260105.30' }
```

### 3. æ£€æŸ¥ DebugPanel

1. æ‰“å¼€åº”ç”¨
2. ç‚¹å‡»"ä¸ªäººä¸­å¿ƒ" â†’ "è¯Šæ–­é¢æ¿"
3. æŸ¥çœ‹"ç‰ˆæœ¬ä¿¡æ¯"éƒ¨åˆ†
4. åº”è¯¥çœ‹åˆ°ï¼š"ç‰ˆæœ¬æ£€æŸ¥å·²ç¦ç”¨ï¼ˆåˆ—ç¼ºå¤±/åŠŸèƒ½å…³é—­ï¼‰"
5. ä¸åº”è¯¥çœ‹åˆ° Network è¯·æ±‚

### 4. æ£€æŸ¥ localStorage

**æ­¥éª¤**:
1. æ‰“å¼€æµè§ˆå™¨ DevTools â†’ Application â†’ Local Storage
2. æŸ¥æ‰¾ `version_check_disabled_column_missing` é”®
3. é¦–æ¬¡å¤±è´¥ååº”è¯¥ä¸º `'true'`
4. æ•°æ®åº“è¿ç§»ååº”è¯¥è¢«æ¸…é™¤

---

## ğŸ“ ç›¸å…³ä»£ç ä½ç½®

### 1. `enforceVersionSync()` ç¼“å­˜æœºåˆ¶
**æ–‡ä»¶**: `src/services/cloudOnly.ts`  
**è¡Œæ•°**: 41-66

### 2. DebugPanel ç¼“å­˜æ£€æŸ¥
**æ–‡ä»¶**: `src/components/DebugPanel.tsx`  
**è¡Œæ•°**: 18-43

---

## âœ… ä¿®å¤å®Œæˆ

**æäº¤**: `fix(400): required_version åˆ—ä¸å­˜åœ¨æ—¶ç¦æ­¢å‘èµ·æŸ¥è¯¢è¯·æ±‚`

**çŠ¶æ€**: âœ… å·²æ„å»ºå¹¶éƒ¨ç½²

**ä¸‹ä¸€æ­¥**: 
1. ç­‰å¾… GitHub Pages éƒ¨ç½²å®Œæˆ
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œ localStorage
3. åˆ·æ–°æµè§ˆå™¨éªŒè¯ä¿®å¤æ•ˆæœ
4. ç¡®è®¤ Network é¢æ¿ä¸­ä¸å†å‡ºç° required_version çš„è¯·æ±‚

**ç¼“å­˜é”®å**: `version_check_disabled_column_missing`

**è‡ªåŠ¨æ¢å¤**: å¦‚æœæ•°æ®åº“è¿ç§»åï¼ŒæŸ¥è¯¢æˆåŠŸæ—¶ä¼šè‡ªåŠ¨æ¸…é™¤æ ‡è®°ï¼Œæ¢å¤ç‰ˆæœ¬æ£€æŸ¥åŠŸèƒ½

