# V260105.31 更新说明

## 📦 版本信息

- **版本号**: V260105.31
- **更新日期**: 2026-01-06
- **Git Commit**: aff4998

---

## ✅ 本次更新内容

### 1. 版本号单一来源机制
- ✅ 版本号只来源于 `src/config/version.ts`
- ✅ 构建时自动注入到 `index.html` 和 `sw.js`
- ✅ 版本号一致性验证机制

### 2. 数据库容错处理
- ✅ `required_version` 列缺失时静默跳过，不阻塞应用启动
- ✅ 缓存机制避免重复查询（减少无意义 400 请求）
- ✅ DebugPanel 显示友好提示

### 3. 性能优化
- ✅ Realtime 单例保护（全局启动门闩）
- ✅ loadData 防重入锁
- ✅ Realtime 事件防抖+去重（400ms）
- ✅ 启动日志优化（"纯云端 Realtime 已启动" 只出现 1 次）

### 4. 乐观锁冲突处理
- ✅ 正确处理 PGRST116 错误（0 rows = 冲突）
- ✅ 自动重试机制（最多 1 次）
- ✅ 友好的错误提示

### 5. 药品写入修复
- ✅ PGRST204 修复（写入前 sanitize，删除 UI-only 字段）
- ✅ 统一 `sanitizeMedicationForDb()` 函数
- ✅ 改进错误提示（显示具体错误消息）

### 6. 体验优化
- ✅ 修复 manifest icon 路径（与 base 路径一致）
- ✅ 移除 Tailwind CDN，改为构建集成
- ✅ 启用 purge，CSS 文件更小（31KB，gzip 5.81KB）
- ✅ 首屏加载性能提升

---

## 🔧 技术改进

### 版本号管理
- 单一来源：`src/config/version.ts`
- 自动注入：Vite 构建时替换占位符
- 一致性验证：DebugPanel 运行时检查

### 性能优化
- Realtime 单例：全局启动门闩避免重复初始化
- 防重入锁：`syncInProgressRef` 防止并发执行
- 事件防抖：400ms 合并快速连续事件
- 事件去重：基于 ID 的去重机制

### 错误处理
- 容错机制：数据库列缺失不阻塞启动
- 冲突处理：乐观锁冲突自动重试
- 错误提示：显示具体错误消息

---

## 📊 性能指标

### CSS 文件大小
- **修复前**: CDN 全量（未 purge）
- **修复后**: 31.43 kB (gzip: 5.81 kB)
- **改进**: 减少约 90% 的 CSS 体积

### 启动日志
- **修复前**: "纯云端 Realtime 已启动" 出现 2 次
- **修复后**: 只出现 1 次
- **改进**: 避免重复初始化

### 网络请求
- **修复前**: 每次启动都查询 `required_version`（400 错误）
- **修复后**: 首次失败后缓存，不再查询
- **改进**: 减少无意义请求

---

## 🎯 验收标准

### ✅ 已实现

1. **版本号一致性**
   - ✅ 所有文件版本号一致（V260105.31）
   - ✅ 构建时自动注入
   - ✅ 运行时验证机制

2. **性能优化**
   - ✅ Realtime 单例正常工作
   - ✅ loadData 防重入锁生效
   - ✅ 事件防抖去重生效

3. **错误处理**
   - ✅ 数据库容错正常工作
   - ✅ 乐观锁冲突正确处理
   - ✅ 药品写入不再出现 PGRST204

4. **体验优化**
   - ✅ 无 icon 下载错误
   - ✅ 无 Tailwind CDN 警告
   - ✅ 首屏加载更快

---

## 📝 部署说明

### 1. 数据库迁移（可选）

如果数据库已迁移，版本检查功能会自动启用。如果未迁移，应用仍可正常运行（容错处理）。

### 2. 清除缓存

建议所有设备清除浏览器缓存后刷新：
- Desktop: Ctrl+Shift+R (Windows) / Cmd+Shift+R (Mac)
- Mobile: 清除浏览器缓存或重新安装 PWA

### 3. 验证更新

1. 打开应用
2. 检查控制台版本号：`📦 当前版本: V260105.31`
3. 检查 DebugPanel：版本信息应一致
4. 验证功能：添加/编辑药品、同步等

---

## 🔍 已知问题

无

---

## 📚 相关文档

- `修复B_容错处理报告.md` - required_version 容错
- `修复C_性能优化报告.md` - 性能优化
- `修复D_乐观锁冲突报告.md` - 乐观锁冲突处理
- `修复PGRST204_药品写入报告.md` - 药品写入修复
- `修复400_减少无意义请求报告.md` - 减少无意义请求
- `修复单例_Realtime启动报告.md` - Realtime 单例
- `修复体验_manifest和Tailwind报告.md` - 体验优化

---

## ✅ 更新完成

**状态**: ✅ 已构建并推送到 GitHub

**下一步**: 
1. 等待 GitHub Pages 自动部署（约 1-2 分钟）
2. 所有设备清除缓存后刷新
3. 验证所有功能正常工作

