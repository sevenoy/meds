# 云端快照管理功能使用指南

## V251219.17 新功能

版本：**V251219.17**  
更新日期：2025年12月19日

---

## 📋 功能概述

### 问题背景

**V251219.16 之前的问题**：
- 即时保存导致冲突
- 设备A和设备B同时修改数据，会互相覆盖
- 无法判断以哪个版本为主
- 缺少冲突检测机制

**V251219.17 的解决方案**：
- ✅ 添加"云端保存"和"云端读取"按钮
- ✅ 保存前自动检测冲突
- ✅ LWW (Last Write Wins) 策略
- ✅ 完整的快照版本管理

---

## 🎯 核心功能

### 1. 云端保存（保存快照）

**位置**：主页标题"药盒助手 V251219.17"下方的蓝色按钮

**功能**：
- 手动将当前所有数据保存为快照
- 自动检测是否有冲突
- 生成快照版本号

**保存的数据**：
```json
{
  "medications": [...],        // 所有药品
  "medication_logs": [...],    // 所有服药记录
  "user_settings": {...},      // 用户设置
  "snapshot_label": "用户名 202512191530"  // 快照版本号
}
```

---

### 2. 云端读取（加载快照）

**位置**：主页标题下方的绿色按钮

**功能**：
- 从云端加载最新快照
- 覆盖本地所有数据
- 显示快照信息

**加载前会显示**：
- 快照名称
- 保存者
- 保存时间

---

## 🔄 工作流程

### 标准使用流程

```
1. 修改数据
   ↓
2. 点击【云端保存】
   ↓
3. 系统检测冲突
   ↓
   ├─ 无冲突 → 保存成功 ✅
   └─ 有冲突 → 提示用户 ⚠️
       ↓
       点击【云端读取】
       ↓
       加载最新数据
       ↓
       重新修改并保存
```

---

## ⚠️ 冲突检测机制

### 什么是冲突？

当满足以下条件时，会发生冲突：
1. 云端快照比本地更新
2. 云端数据内容与本地不同

### 冲突检测流程

```javascript
保存前检测：
1. 获取云端最新快照的时间戳 (cloudTime)
2. 获取本地最后同步的时间戳 (lastSyncTime)
3. 比较数据内容

如果 cloudTime > lastSyncTime：
  ├─ 数据内容相同 → 只更新时间戳，无需保存
  └─ 数据内容不同 → **冲突！** 提示用户先读取
```

### 冲突提示示例

```
⚠️ 检测到冲突！

云端数据已被 "张三" 在 2025-12-19 15:30 更新。

请先点击【云端读取】加载最新数据，然后重新修改并保存。
```

---

## 🎯 多设备使用场景

### 场景1：正常使用（无冲突）

```
设备A：
1. 添加新药品"维生素C"
2. 点击【云端保存】
3. ✅ 保存成功

设备B：
1. 点击【云端读取】
2. ✅ 加载最新数据
3. 显示"维生素C"
```

---

### 场景2：同时修改（有冲突）

```
时间线：

09:00  设备A读取云端快照
       ├─ 快照版本：V1
       └─ 药品列表：降压药、钙片

09:05  设备B读取云端快照
       ├─ 快照版本：V1（相同）
       └─ 药品列表：降压药、钙片

09:10  设备A修改：
       ├─ 添加新药品"维生素C"
       ├─ 药品列表：降压药、钙片、维生素C
       └─ 点击【云端保存】
           └─ ✅ 保存成功（快照版本：V2）

09:15  设备B修改：
       ├─ 添加新药品"叶酸片"
       ├─ 药品列表：降压药、钙片、叶酸片
       └─ 点击【云端保存】
           └─ ⚠️ 检测到冲突！
               └─ 云端已被设备A更新为V2
                   └─ 提示：请先读取最新数据

09:16  设备B处理冲突：
       ├─ 点击【云端读取】
       ├─ 加载V2快照
       ├─ 药品列表：降压药、钙片、维生素C
       ├─ 重新添加"叶酸片"
       ├─ 药品列表：降压药、钙片、维生素C、叶酸片
       └─ 点击【云端保存】
           └─ ✅ 保存成功（快照版本：V3）

最终结果：
  快照V3包含：降压药、钙片、维生素C、叶酸片 ✅
```

---

### 场景3：LWW策略（Last Write Wins）

```
09:00  设备A和设备B都加载了相同的快照V1
       药品列表：降压药、钙片

09:10  设备A修改用户名：
       ├─ 张三 → 李四
       └─ 点击【云端保存】
           └─ ✅ 保存成功（V2）

09:12  设备B修改用户名：
       ├─ 张三 → 王五
       └─ 点击【云端保存】
           └─ ⚠️ 检测到冲突！
               └─ 云端已被设备A更新为V2
                   └─ 提示：请先读取最新数据

处理方式：
设备B点击【云端读取】
  └─ 加载V2（用户名：李四）
      └─ 设备A的修改获胜（Last Write Wins）✅
```

---

## 📝 快照版本号格式

### 格式说明

```
用户名 YYYYMMDDHHmm

示例：
- 张三 202512191530
- 李四 202512191545
```

### 版本号的作用

1. **追踪历史**：知道谁在什么时候保存的
2. **冲突检测**：比较快照名称判断是否有更新
3. **调试排查**：方便定位问题

---

## 🔍 技术实现细节

### 数据库表结构

```sql
CREATE TABLE app_snapshots (
  id UUID PRIMARY KEY,
  key TEXT NOT NULL,                    -- 快照键（"default"）
  owner_id UUID NOT NULL,               -- 用户ID
  payload JSONB NOT NULL,               -- 快照数据
  updated_at TIMESTAMPTZ DEFAULT NOW(), -- 服务器时间戳
  updated_by_name TEXT,                 -- 保存者用户名
  
  UNIQUE (key, owner_id)                -- 每个用户每个key只有一个快照
);
```

### 时间戳跟踪

```javascript
// 本地存储
localStorage.setItem('meds_last_sync_time', serverTime);
localStorage.setItem('meds_last_snapshot_name', snapshotName);

// 保存时比较
if (cloudTime > lastSyncTime) {
  // 云端更新了，检测冲突
}
```

### 冲突检测算法

```javascript
async function saveSnapshot() {
  // 1. 获取本地数据
  const localData = {
    medications: await getMedications(),
    medication_logs: await getMedicationLogs(),
    user_settings: await getUserSettings()
  };
  
  // 2. 查询云端最新快照
  const cloudSnapshot = await queryCloudSnapshot();
  
  // 3. 检查时间戳
  if (cloudSnapshot.updated_at > lastSyncTime) {
    // 4. 比较数据内容
    if (dataEquals(localData, cloudSnapshot.payload)) {
      // 内容相同，只更新时间戳
      return { success: false, message: '数据未改动' };
    } else {
      // 内容不同，冲突！
      return { 
        success: false, 
        message: '检测到冲突！请先读取云端数据' 
      };
    }
  }
  
  // 5. 无冲突，保存快照
  await saveToCloud(localData);
}
```

---

## 🎨 UI设计

### 按钮位置

```
┌─────────────────────────────────────┐
│ 药盒助手 V251219.17                 │
│                                     │
│ [云端保存] [云端读取]                │  ← 新增按钮
└─────────────────────────────────────┘
```

### 按钮样式

- **云端保存**：蓝色按钮，图标：💾
- **云端读取**：绿色按钮，图标：🔄

### 提示信息

#### 保存成功

```
✅ 快照已保存！

快照名称: 张三 202512191530
保存时间: 2025-12-19 15:30:25
```

#### 检测到冲突

```
⚠️ 检测到冲突！

云端数据已被 "李四" 在 2025-12-19 15:25 更新。

请先点击【云端读取】加载最新数据，然后重新修改并保存。
```

#### 读取成功

```
✅ 快照读取成功！

快照名称: 李四 202512191525
保存者: 李四
保存时间: 2025-12-19 15:25:10

⚠️ 加载云端快照将覆盖本地所有数据！

确定要继续吗？
```

---

## 📚 使用建议

### 最佳实践

1. **开始编辑前先读取**
   ```
   打开应用 → 点击【云端读取】→ 确保数据最新
   ```

2. **编辑完成后立即保存**
   ```
   修改数据 → 点击【云端保存】→ 避免冲突
   ```

3. **遇到冲突立即处理**
   ```
   检测到冲突 → 点击【云端读取】→ 重新编辑 → 保存
   ```

### 避免冲突的技巧

1. **使用前先读取**：养成先点击【云端读取】的习惯
2. **修改后立即保存**：不要长时间编辑不保存
3. **多设备协作时沟通**：避免同时修改相同数据

---

## 🔧 故障排除

### 问题1：保存失败

**症状**：
```
保存失败: 网络错误
```

**解决方案**：
1. 检查网络连接
2. 确认已登录
3. 重试保存

---

### 问题2：读取失败

**症状**：
```
云端暂无快照数据
```

**原因**：
- 第一次使用，云端还没有快照
- 或者快照已被删除

**解决方案**：
1. 先在本地添加数据
2. 点击【云端保存】创建第一个快照

---

### 问题3：频繁冲突

**症状**：
- 每次保存都提示冲突
- 多设备同时使用时频繁冲突

**解决方案**：
1. 确保所有设备使用相同的账号
2. 编辑前先点击【云端读取】
3. 编辑完立即保存
4. 多人协作时沟通避免同时编辑

---

## 📊 对比分析

### V251219.16 vs V251219.17

| 特性 | V251219.16 | V251219.17 |
|------|-----------|-----------|
| **保存方式** | 即时自动保存 | 手动保存快照 |
| **冲突检测** | ❌ 无 | ✅ 有 |
| **冲突提示** | ❌ 无 | ✅ 有 |
| **版本管理** | ❌ 无 | ✅ 有 |
| **多设备同时修改** | ❌ 会互相覆盖 | ✅ 提示冲突 |
| **数据安全** | ⚠️ 可能丢失 | ✅ 安全 |

---

## 🎯 总结

### 核心优势

1. **冲突检测**：保存前自动检测是否有冲突
2. **LWW策略**：基于服务器时间戳，后写入获胜
3. **版本管理**：完整的快照版本历史
4. **用户控制**：手动保存和读取，完全掌控
5. **数据安全**：避免数据互相覆盖

### 适用场景

- ✅ 多设备使用（家里电脑 + 手机 + 办公室电脑）
- ✅ 多人协作（家庭共用账号）
- ✅ 需要版本追踪
- ✅ 重要数据保护

---

## 📖 相关文档

- **云端同步技术文档** - 技术实现参考
- **src/services/snapshot.ts** - 快照管理服务
- **supabase_snapshots_migration.sql** - 数据库表结构

---

**文档版本**：V251219.17  
**最后更新**：2025年12月19日  
**作者**：AI Assistant

