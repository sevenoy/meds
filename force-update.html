<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼ºåˆ¶æ›´æ–° - è¯ç›’åŠ©æ‰‹</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }
        .container {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            font-size: 32px;
            font-weight: 900;
            margin: 0 0 20px 0;
            color: #333;
        }
        .version {
            background: #f0f0f0;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            font-family: 'Monaco', 'Courier New', monospace;
        }
        .version-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        .version-label {
            font-weight: bold;
            color: #666;
        }
        .version-value {
            color: #333;
            font-weight: bold;
        }
        .button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.3s;
        }
        .button-primary {
            background: #667eea;
            color: white;
        }
        .button-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        .button-danger {
            background: #ef4444;
            color: white;
        }
        .button-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }
        .button-success {
            background: #10b981;
            color: white;
        }
        .button-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .info {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        .info strong {
            color: #d97706;
        }
        .step {
            margin: 10px 0;
            padding-left: 20px;
        }
        .step::before {
            content: "âœ“ ";
            color: #10b981;
            font-weight: bold;
            margin-left: -20px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å¼ºåˆ¶æ›´æ–°å·¥å…·</h1>
        
        <div class="info">
            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
            å¦‚æœæ‚¨çš„åº”ç”¨æ²¡æœ‰è‡ªåŠ¨æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨æ­¤å·¥å…·å¼ºåˆ¶æ¸…é™¤ç¼“å­˜å¹¶æ›´æ–°ã€‚
        </div>

        <div class="version">
            <div class="version-item">
                <span class="version-label">å½“å‰ç‰ˆæœ¬ï¼š</span>
                <span class="version-value" id="currentVersion">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="version-item">
                <span class="version-label">æœ€æ–°ç‰ˆæœ¬ï¼š</span>
                <span class="version-value">V251219.8</span>
            </div>
            <div class="version-item">
                <span class="version-label">Service Workerï¼š</span>
                <span class="version-value" id="swStatus">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="version-item">
                <span class="version-label">ç¼“å­˜æ•°é‡ï¼š</span>
                <span class="version-value" id="cacheCount">æ£€æµ‹ä¸­...</span>
            </div>
        </div>

        <button class="button button-primary" onclick="checkVersion()">
            ğŸ” æ£€æŸ¥ç‰ˆæœ¬
        </button>

        <button class="button button-danger" onclick="forceUpdate()">
            ğŸš€ å¼ºåˆ¶æ›´æ–°ï¼ˆæ¨èï¼‰
        </button>

        <button class="button button-success" onclick="openApp()">
            âœ¨ æ‰“å¼€åº”ç”¨
        </button>

        <div class="log" id="log"></div>
    </div>

    <script>
        const TARGET_VERSION = 'V251219.17';
        
        function log(message, color = '#00ff00') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span style="color: ${color}">[${time}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // æ£€æŸ¥ç‰ˆæœ¬
        async function checkVersion() {
            log('ğŸ” å¼€å§‹æ£€æŸ¥ç‰ˆæœ¬...', '#00bfff');
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ç‰ˆæœ¬
            const storedVersion = localStorage.getItem('app_version');
            document.getElementById('currentVersion').textContent = storedVersion || 'æœªçŸ¥';
            log(`ğŸ“¦ æœ¬åœ°å­˜å‚¨ç‰ˆæœ¬: ${storedVersion || 'æœªè®¾ç½®'}`);
            log(`ğŸ“¦ ç›®æ ‡ç‰ˆæœ¬: ${TARGET_VERSION}`);
            
            if (storedVersion === TARGET_VERSION) {
                log('âœ… ç‰ˆæœ¬å·²æ˜¯æœ€æ–°ï¼', '#00ff00');
            } else {
                log('âš ï¸ éœ€è¦æ›´æ–°ï¼', '#ffaa00');
            }

            // æ£€æŸ¥ Service Worker
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                document.getElementById('swStatus').textContent = registrations.length > 0 ? 'å·²æ³¨å†Œ' : 'æœªæ³¨å†Œ';
                log(`ğŸ”§ Service Worker æ•°é‡: ${registrations.length}`);
                
                for (const reg of registrations) {
                    if (reg.active) {
                        log(`   - æ´»è·ƒ: ${reg.active.scriptURL}`);
                    }
                    if (reg.waiting) {
                        log(`   - ç­‰å¾…: ${reg.waiting.scriptURL}`, '#ffaa00');
                    }
                }
            }

            // æ£€æŸ¥ç¼“å­˜
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                document.getElementById('cacheCount').textContent = cacheNames.length;
                log(`ğŸ’¾ ç¼“å­˜æ•°é‡: ${cacheNames.length}`);
                cacheNames.forEach(name => {
                    log(`   - ${name}`);
                });
            }
        }

        // å¼ºåˆ¶æ›´æ–°
        async function forceUpdate() {
            log('ğŸš€ å¼€å§‹å¼ºåˆ¶æ›´æ–°...', '#ff00ff');
            log('');
            
            try {
                // æ­¥éª¤1: æ¸…é™¤æ‰€æœ‰ç¼“å­˜
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    log(`ğŸ“ æ­¥éª¤1: æ¸…é™¤ ${cacheNames.length} ä¸ªç¼“å­˜`);
                    
                    for (const name of cacheNames) {
                        await caches.delete(name);
                        log(`   âœ“ å·²åˆ é™¤: ${name}`, '#00ff00');
                    }
                    
                    log('âœ… æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤', '#00ff00');
                } else {
                    log('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒç¼“å­˜API', '#ffaa00');
                }
                
                log('');
                
                // æ­¥éª¤2: æ³¨é”€æ‰€æœ‰ Service Worker
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    log(`ğŸ“ æ­¥éª¤2: æ³¨é”€ ${registrations.length} ä¸ªService Worker`);
                    
                    for (const reg of registrations) {
                        await reg.unregister();
                        log(`   âœ“ å·²æ³¨é”€`, '#00ff00');
                    }
                    
                    log('âœ… æ‰€æœ‰Service Workerå·²æ³¨é”€', '#00ff00');
                } else {
                    log('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒService Worker', '#ffaa00');
                }
                
                log('');
                
                // æ­¥éª¤3: æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ç‰ˆæœ¬å·
                log('ğŸ“ æ­¥éª¤3: æ¸…é™¤æœ¬åœ°å­˜å‚¨');
                localStorage.removeItem('app_version');
                log('âœ… æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤', '#00ff00');
                
                log('');
                
                // æ­¥éª¤4: ç­‰å¾…å¹¶åˆ·æ–°
                log('ğŸ“ æ­¥éª¤4: å‡†å¤‡åˆ·æ–°é¡µé¢', '#00bfff');
                log('â° 3ç§’åè‡ªåŠ¨è·³è½¬åˆ°é¦–é¡µ...', '#ffaa00');
                
                setTimeout(() => {
                    log('ğŸ”„ æ­£åœ¨è·³è½¬...', '#00ff00');
                    window.location.href = '/meds/?v=' + TARGET_VERSION + '&t=' + Date.now();
                }, 3000);
                
            } catch (error) {
                log('âŒ æ›´æ–°å¤±è´¥: ' + error.message, '#ff0000');
                log('è¯·æ‰‹åŠ¨åˆ·æ–°æµè§ˆå™¨ï¼ˆCtrl+Shift+R æˆ– Cmd+Shift+Rï¼‰', '#ffaa00');
            }
        }

        // æ‰“å¼€åº”ç”¨
        function openApp() {
            log('âœ¨ æ­£åœ¨æ‰“å¼€åº”ç”¨...', '#00bfff');
            window.location.href = '/meds/?v=' + TARGET_VERSION + '&t=' + Date.now();
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            log('ğŸ‘‹ æ¬¢è¿ä½¿ç”¨å¼ºåˆ¶æ›´æ–°å·¥å…·', '#00bfff');
            log('');
            checkVersion();
        });
    </script>
</body>
</html>
