# 时间戳权威模型修复报告

## 修复完成时间
2025-01-XX

## 修复内容

### ✅ 问题1：药品颜色选择器重新设计
**修复位置：**
- `App.tsx` (新增药品、编辑药品)
- `src/components/MedicationManagePage.tsx` (新增药品、编辑药品)

**修改内容：**
- 完全移除 `<input type="color">` 颜色转盘
- 替换为 8 个颜色卡片网格（青柠、浆果、薄荷、蓝色、紫色、橙色、红色、青色）
- 每个颜色卡片明确可见，选中状态清晰（黑色边框 + 放大效果）

### ✅ 问题2：药品颜色主题即时同步
**修复位置：**
- `App.tsx` (Realtime 订阅处理)

**修改内容：**
- 确认 `accent` 字段存储在 `medications` 表
- 所有颜色修改通过 `upsertMedicationToCloud()` 写入数据库
- Realtime 订阅 `medications` 表的 UPDATE 事件
- 首页颜色展示只来源于 Realtime state（通过 `onMedicationChange` 回调更新）

### ✅ 问题3：刷新后服药记录变成0（灾难级修复）
**修复位置：**
- `App.tsx` (`loadData` 函数、`onLogChange` 回调)

**修改内容：**
- 引入基于时间戳的合并逻辑
- `loadData` 中合并 logs 时：
  - 比较 `updated_at` / `created_at` / `taken_at` 时间戳
  - 时间新的覆盖时间旧的，永远不能反向覆盖
- Realtime `onLogChange` 中：
  - 更新现有记录时比较时间戳
  - 如果新数据时间戳更旧，拒绝覆盖（保留旧数据）
- 页面刷新后从数据库拉取完整历史记录，绝不返回 0

**关键代码：**
```typescript
// 合并逻辑：基于时间戳
const cloudTime = new Date(cloudLog.updated_at || cloudLog.created_at || cloudLog.taken_at).getTime();
const localTime = new Date(existing.updated_at || existing.created_at || existing.taken_at).getTime();
if (cloudTime >= localTime) {
  // 云端数据更新或相等，使用云端数据
  mergedLogs.push(cloudLog);
} else {
  // 本地数据更新，保留本地数据
  mergedLogs.push(existing);
}
```

### ✅ 问题4：用户名修改即时同步
**修复位置：**
- `App.tsx` (用户名初始化、保存逻辑、Realtime 订阅)
- `src/services/userSettings.ts` (已有服务，已确认支持)

**修改内容：**
- 用户名存储在 `user_settings.settings.userName` 字段
- 所有用户名修改通过 `updateUserSettings({ userName })` 写入数据库
- 启用 `initSettingsRealtimeSync` 监听 `user_settings` 表变更
- 所有显示用户名的地方从 Realtime state 获取（不再使用 localStorage 缓存）
- 自动迁移旧数据：从 localStorage 读取并迁移到 user_settings

## 新增/修改的字段

### 数据库字段（已存在，无需新增）
- `medications.accent` - 药品颜色字段（TEXT）
- `medication_logs.updated_at` - 记录更新时间戳（TIMESTAMPTZ）
- `medication_logs.created_at` - 记录创建时间戳（TIMESTAMPTZ）
- `user_settings.settings.userName` - 用户名（JSONB 中的字段）
- `user_settings.updated_at` - 设置更新时间戳（TIMESTAMPTZ）

## 合并逻辑位置

1. **服药记录合并** (`App.tsx:559-573`)
   - `loadData` 函数中合并云端和本地 logs
   - 基于 `updated_at` / `created_at` / `taken_at` 时间戳

2. **Realtime 记录更新** (`App.tsx:906-922`)
   - `onLogChange` 回调中处理 INSERT/UPDATE
   - 基于时间戳决定是否更新

3. **药品合并** (`App.tsx:511-557`)
   - `loadData` 函数中合并云端和本地 medications
   - 保留本地计算的 status 和 lastLog

4. **用户名合并** (`src/services/userSettings.ts:64-152`)
   - `saveUserSettings` 函数中检测冲突
   - 基于 `updated_at` 时间戳（LWW 策略）

## 时间戳如何防止数据回滚

1. **数据库时间戳 = 唯一权威**
   - 使用 `created_at`、`updated_at` 作为判断依据
   - 禁止客户端时间作为最终判断

2. **合并规则**
   - 时间新的覆盖时间旧的
   - 永远不能反向覆盖（旧数据无法覆盖新数据）

3. **拒绝覆盖机制**
   - 在 Realtime 更新时检查时间戳
   - 如果新数据时间戳更旧，直接忽略（不更新 state）

4. **完整历史记录**
   - 页面刷新后从数据库拉取完整历史
   - 合并时保留所有记录，只更新时间戳更新的记录

## 最终确认

**系统已升级为基于时间戳的权威 Realtime 模型，旧数据无法覆盖新数据，所有设置与记录即时同步。**

## 测试要点

1. ✅ 任意设备修改药品颜色 → 其他设备立即同步
2. ✅ 任意设备修改用户名 → 其他设备立即同步
3. ✅ 任意设备添加服药记录 → 其他设备立即同步
4. ✅ 任意设备刷新页面 → 服药记录绝不归零，历史数据完整存在
5. ✅ 旧设备不允许覆盖新设备已产生的数据（时间戳旧的更新被拒绝）

