# 紧急修复操作指南 V260105.11

## 🔍 问题诊断结果

根据运行时日志分析,确认以下问题:

### ✅ 已确认的问题

1. **浏览器缓存问题** 
   - 控制台显示: `📦 当前版本: V260103.01` (旧版本)
   - 代码实际版本: `V260105.10` (最新版本)
   - 原因: Service Worker 和浏览器缓存

2. **数据库 Schema 错误**
   - 错误信息: `Could not find the 'device_id' column of 'medications' in the schema cache`
   - 原因: Supabase 的 `medications` 和 `medication_logs` 表缺少 `device_id` 列

3. **认证系统正常** ✅
   - 日志确认: userId = `53b1d982-29b2-44f8-ab61-3a36e434f591`
   - 用户邮箱: `sevenoy@gmail.com`

---

## 🛠️ 修复步骤

### 第一步: 修复数据库 Schema

1. 打开 **Supabase Dashboard**
2. 进入 **SQL Editor**
3. 复制并执行以下 SQL:

```sql
-- 1. 为 medications 表添加 device_id 列
ALTER TABLE public.medications 
ADD COLUMN IF NOT EXISTS device_id text;

-- 2. 为 medication_logs 表添加 device_id 列
ALTER TABLE public.medication_logs 
ADD COLUMN IF NOT EXISTS device_id text;

-- 3. 创建索引以提高查询性能
CREATE INDEX IF NOT EXISTS idx_medications_device_id 
ON public.medications(device_id);

CREATE INDEX IF NOT EXISTS idx_medication_logs_device_id 
ON public.medication_logs(device_id);

-- 4. 刷新 PostgREST schema cache (非常重要!)
NOTIFY pgrst, 'reload schema';
```

4. 确认执行成功,应该看到 `Success. No rows returned`

---

### 第二步: 强制清除浏览器缓存

#### 方法 A: 使用控制台脚本(推荐)

1. 在浏览器中打开应用 (https://sevenoy.github.io/meds/)
2. 按 `F12` 打开开发者工具
3. 切换到 **Console** 标签
4. 粘贴以下代码并按回车:

```javascript
(async () => {
  console.log('🧹 开始清理所有缓存...');
  
  // 1. 注销所有 Service Worker
  if ('serviceWorker' in navigator) {
    const registrations = await navigator.serviceWorker.getRegistrations();
    for (const reg of registrations) {
      await reg.unregister();
      console.log('✅ Service Worker 已注销:', reg.scope);
    }
  }
  
  // 2. 清除所有 Cache Storage
  if ('caches' in window) {
    const cacheNames = await caches.keys();
    for (const name of cacheNames) {
      await caches.delete(name);
      console.log('✅ Cache 已删除:', name);
    }
  }
  
  // 3. 清除 localStorage
  localStorage.clear();
  console.log('✅ localStorage 已清除');
  
  // 4. 清除 sessionStorage
  sessionStorage.clear();
  console.log('✅ sessionStorage 已清除');
  
  // 5. 删除所有 IndexedDB
  if (window.indexedDB) {
    const dbs = await indexedDB.databases();
    for (const db of dbs) {
      indexedDB.deleteDatabase(db.name);
      console.log('✅ IndexedDB 已删除:', db.name);
    }
  }
  
  console.log('🎉 所有缓存已清除!');
  console.log('⚠️ 5秒后将自动刷新页面...');
  
  setTimeout(() => {
    window.location.reload(true);
  }, 5000);
})();
```

5. 等待脚本执行完成(约5秒)
6. 页面会自动刷新

#### 方法 B: 手动清除(备用)

1. **Chrome/Edge**:
   - 按 `Ctrl+Shift+Delete` (Windows) 或 `Cmd+Shift+Delete` (Mac)
   - 选择 "全部时间"
   - 勾选: 缓存的图像和文件、Cookie 及其他网站数据
   - 点击 "清除数据"

2. **Safari**:
   - 菜单栏 → 开发 → 清空缓存
   - 或: 设置 → 高级 → 网站数据 → 移除所有网站数据

3. **Firefox**:
   - 按 `Ctrl+Shift+Delete`
   - 选择 "所有历史记录"
   - 勾选: 缓存、Cookie
   - 点击 "立即清除"

4. 清除完成后,按 `Ctrl+Shift+R` (Windows) 或 `Cmd+Shift+R` (Mac) 强制刷新

---

### 第三步: 验证修复

刷新后,在控制台检查:

#### ✅ 成功标志:

```
📦 当前版本: V260105.10
✅ 使用默认 Supabase 配置（生产环境）
✅ Service Worker 注册成功: /meds/sw.js
✅ cloudLoadV2() 读取成功
✅ 云端数据已加载并初始化 payload
🔗 Realtime 连接状态变更: connected
```

#### ❌ 如果还有问题:

- **版本号错误**: 再次清除缓存,或使用无痕模式测试
- **device_id 错误**: 确认 SQL 执行成功,并执行了 `NOTIFY pgrst, 'reload schema';`
- **认证失败**: 确认 Supabase Dashboard 中有 `sevenoy@gmail.com` 用户

---

## 📱 多设备测试

修复完成后,测试多设备同步:

1. **设备 A**: 添加一个新药品
2. **设备 B**: 应在 1-2 秒内看到新药品(自动同步)
3. **设备 A**: 添加一条服药记录
4. **设备 B**: 应在 1-2 秒内看到新记录
5. 查看控制台,应显示: `🔔 检测到药品变更（新Realtime），从云端重新加载...`

---

## 🔧 如果问题依然存在

### 检查清单:

1. ✅ Supabase SQL 是否执行成功?
2. ✅ 是否看到 `NOTIFY pgrst, 'reload schema';` 的成功消息?
3. ✅ 浏览器缓存是否完全清除?(尝试无痕模式)
4. ✅ 控制台版本号是否为 `V260105.10`?
5. ✅ 网络请求中是否还有 404 错误?

### 调试方法:

1. **检查数据库**:
   ```sql
   -- 确认 device_id 列存在
   SELECT column_name, data_type 
   FROM information_schema.columns 
   WHERE table_name = 'medications' 
   AND column_name = 'device_id';
   ```

2. **检查 Service Worker**:
   - 开发者工具 → Application → Service Workers
   - 点击 "Unregister" 手动注销
   - 刷新页面

3. **查看网络请求**:
   - 开发者工具 → Network
   - 刷新页面
   - 查找 `medications` 相关的 API 请求
   - 检查请求参数中是否包含 `device_id`

---

## 📝 技术说明

### 为什么会出现缓存问题?

1. **Service Worker 缓存策略**: PWA 应用使用 Service Worker 缓存静态资源,提高离线体验
2. **Cache-First 策略**: 优先从缓存加载,只有缓存失效才从网络加载
3. **版本更新机制**: 需要显式的版本检查和缓存清理机制

### 为什么需要 device_id?

1. **多设备同步**: 防止设备 A 的更新触发设备 A 的 Realtime 回调(造成无限循环)
2. **过滤机制**: Realtime 订阅时过滤 `device_id != 当前设备ID`,只监听其他设备的更改
3. **冲突解决**: 通过 `device_id` 追踪数据来源,便于冲突解决

---

## 🎯 预期结果

修复完成后:

- ✅ 所有设备显示相同版本 `V260105.10`
- ✅ 多设备实时同步正常(1-2秒延迟)
- ✅ 添加/编辑/删除药品立即同步
- ✅ 服药记录实时更新
- ✅ 控制台无 Schema 错误
- ✅ 右上角显示 🟢 已连接(Realtime 状态)

---

## 📞 如果还有问题

请提供以下信息:

1. 控制台完整日志(特别是版本号和错误信息)
2. Supabase SQL 执行结果截图
3. 使用的浏览器和版本
4. 清除缓存的方法(脚本 or 手动)

