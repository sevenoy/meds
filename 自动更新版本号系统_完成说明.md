# 自动更新版本号系统 - 完成说明

## ✅ 已完成功能

### 1. 自动版本号更新脚本

创建了3个版本的脚本:

1. **update-version.mjs** (主要,推荐使用)
   - Node.js ES模块格式
   - 跨平台支持 (Windows/macOS/Linux)
   - 完整的交互式界面
   - Git 集成 (可选)

2. **update-version.sh** (备用)
   - Bash 脚本版本
   - 适用于 macOS/Linux
   - 功能与 mjs 版本相同

3. **update-version.js** (已废弃)
   - CommonJS 格式,不兼容项目配置
   - 已被 update-version.mjs 替代

### 2. npm 快捷命令

```json
{
  "scripts": {
    "update-version": "node update-version.mjs"
  }
}
```

使用方法:
```bash
npm run update-version
```

### 3. 版本号规则

格式: `V[YY][MM][DD].[序号]`

示例:
```
V260105.01  - 2026年1月5日 第1个版本
V260105.02  - 2026年1月5日 第2个版本
V260105.03  - 2026年1月5日 第3个版本
V260106.01  - 2026年1月6日 第1个版本 (新的一天重置)
```

自动递增逻辑:
- **同一天**: 序号递增 (01 → 02 → 03)
- **新的一天**: 序号重置为 01

---

## 📁 创建的文件

1. ✅ `update-version.mjs` - 主要更新脚本
2. ✅ `update-version.sh` - Bash 备用脚本
3. ✅ `VERSION_UPDATE_GUIDE.md` - 完整使用指南
4. ✅ `VERSION_QUICK_START.md` - 快速开始指南
5. ✅ `package.json` - 更新了 npm 脚本配置

---

## 🚀 使用方法

### 基础用法

```bash
npm run update-version
```

### 完整交互流程

```
$ npm run update-version

🔄 自动更新版本号工具

📌 当前版本: V260105.02
✨ 新版本号: V260105.03

是否更新版本号? (y/n): y
✅ 版本号已更新为: V260105.03

📝 修改内容:
-export const APP_VERSION = 'V260105.02';
+export const APP_VERSION = 'V260105.03';

是否提交到 Git? (y/n): y
✅ 已提交到 Git

是否推送到远程仓库? (y/n): y
✅ 已推送到远程仓库

🎉 版本更新完成!
📌 新版本: V260105.03
```

---

## 🎯 工作流程

### 标准开发流程

```bash
# 1. 修改代码
vim App.tsx

# 2. 测试功能
npm run dev

# 3. 自动更新版本号
npm run update-version
# 输入: y → y → y

# 4. 构建项目
npm run build

# 5. 部署到生产环境
# (自动或手动部署)
```

---

## 🔍 脚本功能

### 自动化功能

1. ✅ **读取当前版本号**
   - 自动从 `src/config/version.ts` 读取
   - 解析版本号格式 `V260105.02`

2. ✅ **生成新版本号**
   - 基于当前日期自动生成
   - 同一天自动递增序号
   - 新的一天重置为 01

3. ✅ **更新版本号文件**
   - 直接修改 `src/config/version.ts`
   - 保持文件格式不变

4. ✅ **Git 集成** (可选)
   - 自动 `git add`
   - 自动 `git commit` (提交信息: `🔖 更新版本号到 V260105.03`)
   - 可选 `git push`

5. ✅ **交互式确认**
   - 每一步都有确认提示
   - 可以随时取消操作

6. ✅ **显示变更**
   - 自动显示 Git diff
   - 清晰展示版本号变更

---

## 📊 版本号显示位置

更新版本号后,以下位置会自动更新:

1. **页面标题**
   ```
   药盒助手 V260105.03
   ```

2. **个人中心**
   ```
   药品管理
   版本 V260105.03
   ```

3. **关于页面**
   ```
   药盒助手
   版本 V260105.03
   ```

4. **控制台日志**
   ```javascript
   console.log(`[App] 当前版本: ${APP_VERSION}`);
   // 输出: [App] 当前版本: V260105.03
   ```

---

## 🔧 技术实现

### 1. 版本号配置 (统一管理)

```typescript
// src/config/version.ts
export const APP_VERSION = 'V260105.03';
```

### 2. 导入版本号 (自动引用)

```typescript
// App.tsx
import { APP_VERSION } from './src/config/version';

// 使用
<h1>药盒助手 {APP_VERSION}</h1>
```

### 3. 更新脚本 (自动化)

```javascript
// update-version.mjs
const newVersion = `V${newDate}.${newSeq}`;
const newContent = content.replace(
  /APP_VERSION = '.+'/,
  `APP_VERSION = '${newVersion}'`
);
fs.writeFileSync(VERSION_FILE, newContent, 'utf8');
```

---

## 📝 示例场景

### 场景1: 修复Bug后更新版本

```bash
# 修复Bug
vim App.tsx

# 更新版本号
npm run update-version
# V260105.02 → V260105.03

# 提交
git add App.tsx
git commit -m "修复日历颜色显示 - V260105.03"
git push
```

### 场景2: 添加新功能后更新版本

```bash
# 添加新功能
vim App.tsx
vim NewFeature.tsx

# 更新版本号
npm run update-version
# V260105.03 → V260105.04

# 提交所有修改
git add .
git commit -m "添加药品提醒功能 - V260105.04"
git push
```

### 场景3: 每日第一次提交

```bash
# 新的一天开始开发
npm run update-version
# V260105.04 → V260106.01 (新的一天,重置为01)

# 修改代码
vim App.tsx

# 提交
git add .
git commit -m "开始新一天的开发 - V260106.01"
git push
```

---

## ⚡ 优势

1. **自动化**: 一个命令完成所有操作
2. **规范化**: 统一的版本号格式
3. **集成化**: 与 Git 无缝集成
4. **可追溯**: 每个版本号对应一个提交
5. **易维护**: 只需修改一个配置文件
6. **跨平台**: 支持 Windows/macOS/Linux

---

## 🛠️ 故障排查

### 问题1: 脚本无法运行

**错误:**
```bash
Error: Cannot find module 'update-version.mjs'
```

**解决:**
```bash
# 确认文件存在
ls -la update-version.mjs

# 给脚本添加执行权限
chmod +x update-version.mjs

# 重新运行
npm run update-version
```

### 问题2: Git 操作失败

**错误:**
```bash
fatal: not a git repository
```

**解决:**
```bash
# 初始化 Git 仓库
git init
git remote add origin <your-repo-url>

# 重新运行脚本
npm run update-version
```

### 问题3: 版本号格式错误

**错误:**
```bash
❌ 无法解析当前版本号
```

**解决:**
```bash
# 检查版本号文件格式
cat src/config/version.ts

# 应该是这样的格式:
export const APP_VERSION = 'V260105.02';

# 注意:
# - 必须用单引号 '...'
# - V 必须大写
# - 日期必须是 6 位数字
# - 序号必须是 2 位数字
```

---

## 📚 相关文档

- `VERSION_QUICK_START.md` - 快速开始指南 (简化版)
- `VERSION_UPDATE_GUIDE.md` - 完整使用指南 (详细版)
- `src/config/version.ts` - 版本号配置文件
- `App.tsx` - 版本号使用示例

---

## ✅ 测试验证

### 测试步骤

1. **运行更新脚本**
   ```bash
   npm run update-version
   ```

2. **检查版本号文件**
   ```bash
   cat src/config/version.ts
   # 应显示新版本号
   ```

3. **检查 Git 提交**
   ```bash
   git log -1
   # 应显示: 🔖 更新版本号到 V260105.03
   ```

4. **检查页面显示**
   ```bash
   npm run dev
   # 打开浏览器,查看页面标题是否显示新版本号
   ```

---

## 🎉 总结

已成功创建自动更新版本号系统!

**核心功能:**
- ✅ 自动生成版本号 (基于日期)
- ✅ 自动递增序号 (同一天)
- ✅ 自动更新配置文件
- ✅ 可选 Git 提交和推送
- ✅ 交互式确认界面
- ✅ 跨平台支持

**使用方法:**
```bash
npm run update-version
```

就这么简单! 🚀

---

© 2026 药盒助手 | 自动化版本管理系统



