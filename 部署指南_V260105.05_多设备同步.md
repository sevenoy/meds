# 🚀 部署指南 V260105.05 - 多设备实时同步

## ✅ 代码已推送

```
✅ Git 提交: 5db905e
✅ 推送到远程: origin/main
✅ 版本号: V260105.05
```

---

## 📋 部署步骤

### 步骤1: 启用 Supabase Realtime (必须!)

**✅ 已通过 SQL 正确配置!**

您已经执行了以下 SQL:

```sql
ALTER PUBLICATION supabase_realtime ADD TABLE public.medications;
ALTER PUBLICATION supabase_realtime ADD TABLE public.medication_logs;
ALTER PUBLICATION supabase_realtime ADD TABLE public.user_settings;
```

**验证方法:**

在 Supabase SQL Editor 中执行:

```sql
SELECT * FROM pg_publication_tables 
WHERE pubname = 'supabase_realtime';
```

应该返回:
```
medications
medication_logs
user_settings
```

**✅ 如果看到这3个表,说明 Realtime 已正确启用!**

---

### 步骤2: 清除所有设备缓存

**目的:** 确保所有设备使用最新代码

**操作:**

#### 设备A (电脑)
1. 打开应用 (sevenoy.github.io/meds)
2. 按 `F12` 打开控制台
3. 进入 "我的" 页面
4. 点击 **"清除缓存"** 按钮
5. 等待页面自动刷新
6. 确认版本号显示 `V260105.05`

#### 设备B (手机)
1. 打开应用
2. 进入 "我的" 页面
3. 点击 **"清除缓存"** 按钮
4. 等待页面自动刷新
5. 确认版本号显示 `V260105.05`

#### 设备C (平板)
1. 同上

---

### 步骤3: 清空所有数据 (推荐)

**目的:** 确保所有设备从同一起点开始,避免旧数据干扰

**操作:**

1. **选择一个设备** (例如设备A)
2. 进入 "我的" 页面
3. 点击 **"清除所有药品"** 按钮 (红色按钮)
4. 确认两次删除
5. 查看控制台,应该显示:
   ```
   🗑️ 开始清除所有药品数据...
   📦 清除本地 IndexedDB...
   ✅ 本地数据库已清空
   📦 清除 payload...
   ✅ 云端数据已清空
   📦 清除 Supabase 数据...
   ✅ Supabase 药品数据已清空
   ✅ Supabase 记录数据已清空
   🔄 重新加载数据...
   🎉 清除完成！
   ```

6. **其他设备** (设备B/C)
   - 刷新页面
   - 应该显示 "暂无药品"

---

### 步骤4: 验证版本号

**所有设备都应该显示相同的版本号**

**查看方法:**
- 首页顶部: "药盒助手 V260105.05"
- 控制台日志: 搜索 "版本"

**如果版本号不是 V260105.05:**
- 重新清除缓存
- 强制刷新: `Ctrl+Shift+R` (Windows) / `Cmd+Shift+R` (Mac)

---

### 步骤5: 验证 Realtime 连接

**打开控制台 (F12),查看日志**

**应该看到:**
```
✅ 新 Realtime 服务已启动（基于 Supabase Realtime）
🔗 Realtime 连接状态变更: connecting
🔗 Realtime 连接状态变更: connected
```

**如果看到 `disconnected`:**
1. 检查网络连接
2. 确认 Supabase Realtime 已启用 (步骤1)
3. 查看控制台是否有错误信息

**如果看到 `connecting` 一直不变:**
- 等待10秒
- 如果还是 `connecting`,刷新页面

---

## 🧪 测试多设备同步

### 测试1: 添加药品同步

**操作:**

1. **设备A**: 添加药品 "测试药A"
   - 进入 "我的" → "药品管理"
   - 填写信息:
     - 名称: 测试药A
     - 剂量: 1片
     - 时间: 08:00
   - 点击 "添加药品"

2. **查看设备A控制台:**
   ```
   ✅ 新药品已成功写入 payload 并同步到云端
   ✅ 新药品已同步到 Supabase
   🔄 开始加载数据...
   ☁️ 从云端拉取最新数据...
   ✅ 云端数据已同步到本地
   📋 已加载 1 个药物: ['测试药A']
   ```

3. **设备B/C**: 观察 (不要手动刷新)
   - **1-2秒内**,应该:
     - 右上角显示绿色通知: "✅ 药品数据已同步"
     - 首页自动显示 "测试药A"

4. **查看设备B/C控制台:**
   ```
   🔔 检测到药品变更,从云端重新加载...
   ☁️ 从云端拉取最新数据...
   ✅ 云端数据已同步到本地
   📋 已加载 1 个药物: ['测试药A']
   ```

**预期结果:**
- ✅ 设备B/C 自动显示 "测试药A"
- ✅ 无需手动刷新
- ✅ 显示绿色通知提示

---

### 测试2: 编辑药品同步

**操作:**

1. **设备A**: 编辑 "测试药A"
   - 进入 "我的" → "药品管理"
   - 点击 "测试药A" 的编辑按钮 (蓝色)
   - 修改名称为 "测试药A-已修改"
   - 点击 "保存"

2. **设备B/C**: 观察
   - **1-2秒内**,自动更新为 "测试药A-已修改"

**预期结果:**
- ✅ 所有设备显示 "测试药A-已修改"

---

### 测试3: 删除药品同步

**操作:**

1. **设备A**: 删除 "测试药A-已修改"
   - 进入 "我的" → "药品管理"
   - 点击删除按钮 (红色)
   - 确认删除

2. **设备B/C**: 观察
   - **1-2秒内**,药品自动消失

**预期结果:**
- ✅ 所有设备都不再显示该药品

---

### 测试4: 服药记录同步

**操作:**

1. **设备A**: 添加药品 "测试药B"
2. **设备B**: 等待同步 (1-2秒)
3. **设备B**: 点击 "测试药B" 的拍照按钮
4. 上传照片,完成服药记录
5. **设备A/C**: 观察
   - **1-2秒内**,自动显示蓝色通知: "✅ 服药记录已同步"
   - "测试药B" 状态变为 "已完成" (绿色对勾)

**预期结果:**
- ✅ 所有设备同步显示服药记录

---

## 🔍 故障排查

### 问题1: 数据还是不同步

**症状:** 设备A添加药品,设备B/C看不到

**排查步骤:**

1. **检查版本号**
   - 所有设备都是 V260105.05?
   - 如果不是,重新清除缓存

2. **检查 Realtime 状态**
   - 打开设备B/C的控制台
   - 搜索 "Realtime 连接状态"
   - 应该显示 `connected`
   - 如果是 `disconnected`,刷新页面

3. **检查 Supabase Realtime**
   - 登录 Supabase Dashboard
   - Database → Replication
   - 确认 medications, medication_logs, user_settings 都已启用
   - 如果未启用,启用后刷新所有设备

4. **查看控制台错误**
   - 是否有红色错误信息?
   - 截图发送给开发者

---

### 问题2: 显示 "disconnected"

**症状:** 控制台显示 `🔗 Realtime 连接状态: disconnected`

**可能原因:**
- 网络问题
- Supabase Realtime 未启用
- Supabase 配额用完

**解决方法:**

1. **检查网络**
   - 打开其他网站,确认网络正常

2. **检查 Supabase Realtime**
   - 登录 Dashboard
   - Database → Replication
   - 确认已启用

3. **检查配额**
   - 登录 Dashboard
   - Settings → Usage
   - 查看 Realtime 配额是否用完
   - 如果用完,升级套餐或等待重置

4. **重新连接**
   - 刷新页面
   - 应该自动重新连接

---

### 问题3: 添加药品后没有通知

**症状:** 设备B/C没有显示绿色通知

**可能原因:**
- Realtime 回调被忽略
- 通知元素被移除

**解决方法:**

1. **查看控制台**
   - 是否显示 "🔔 检测到药品变更"?
   - 如果显示,说明 Realtime 正常工作
   - 通知可能只是没显示,但数据已同步

2. **刷新页面**
   - 手动刷新,确认数据已同步

---

### 问题4: 数据诊断显示不一致

**症状:** 点击 "数据诊断",显示:
```
本地数据库: 5 个药品
Payload: 3 个药品
Supabase: 10 个药品
当前显示: 5 个药品
```

**分析:**
- 数据源不一致
- 可能是旧数据残留

**解决方法:**

1. **清空所有数据**
   - 点击 "清除所有药品"
   - 确认删除

2. **验证清空**
   - 再次点击 "数据诊断"
   - 应该全部显示 0

3. **重新开始**
   - 添加新药品
   - 测试同步

---

## 📊 成功标志

### 所有设备都应该:

- ✅ 版本号显示 `V260105.05`
- ✅ Realtime 状态显示 `connected`
- ✅ 添加药品后1-2秒自动同步
- ✅ 显示绿色/蓝色同步通知
- ✅ 数据诊断显示一致的数字

### 控制台应该显示:

```
🔄 开始加载数据...
☁️ 从云端拉取最新数据...
✅ 云端数据已同步到本地
📋 已加载 X 个药物: [...]
✅ 新 Realtime 服务已启动（基于 Supabase Realtime）
🔗 Realtime 连接状态: connected
```

---

## 🎯 测试清单

部署后,请按顺序完成以下测试:

- [ ] 步骤1: 启用 Supabase Realtime
- [ ] 步骤2: 清除所有设备缓存
- [ ] 步骤3: 清空所有数据
- [ ] 步骤4: 验证版本号 (V260105.05)
- [ ] 步骤5: 验证 Realtime 连接 (connected)
- [ ] 测试1: 添加药品同步
- [ ] 测试2: 编辑药品同步
- [ ] 测试3: 删除药品同步
- [ ] 测试4: 服药记录同步

---

## 📞 需要帮助?

如果遇到问题:

1. **查看文档:**
   - `修复说明_V260105.05_多设备实时同步.md`
   - `多设备同步问题诊断.md`

2. **提供信息:**
   - 版本号截图
   - 控制台日志截图
   - 数据诊断报告截图

3. **常见问题:**
   - Supabase Realtime 是否已启用?
   - 所有设备版本号是否一致?
   - Realtime 状态是否为 connected?

---

**部署完成后,所有设备将实现1-2秒的实时同步!** 🎉

---

© 2026 药盒助手 V260105.05 | 多设备实时同步版本

