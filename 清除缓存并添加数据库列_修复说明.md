# 清除缓存并添加数据库列 - 修复说明

## 问题诊断

通过日志分析,发现两个核心问题:

1. **浏览器缓存问题**: 控制台显示 `V260103.01`,但代码已更新到 `V260105.10`
2. **数据库 Schema 缺失**: `medications` 表缺少 `device_id` 列

## 解决方案

### 步骤 1: 添加数据库列

在 Supabase Dashboard → SQL Editor 中执行以下 SQL:

```sql
-- 为 medications 表添加 device_id 列
ALTER TABLE public.medications 
ADD COLUMN IF NOT EXISTS device_id text;

-- 为 medication_logs 表添加 device_id 列
ALTER TABLE public.medication_logs 
ADD COLUMN IF NOT EXISTS device_id text;

-- 创建索引以提高查询性能
CREATE INDEX IF NOT EXISTS idx_medications_device_id 
ON public.medications(device_id);

CREATE INDEX IF NOT EXISTS idx_medication_logs_device_id 
ON public.medication_logs(device_id);

-- 刷新 PostgREST schema cache
NOTIFY pgrst, 'reload schema';
```

### 步骤 2: 强制清除浏览器缓存

在浏览器控制台执行以下代码:

```javascript
(async () => {
  console.log('🧹 开始清理所有缓存...');
  
  // 1. 注销所有 Service Worker
  if ('serviceWorker' in navigator) {
    const registrations = await navigator.serviceWorker.getRegistrations();
    for (const reg of registrations) {
      await reg.unregister();
      console.log('✅ Service Worker 已注销:', reg.scope);
    }
  }
  
  // 2. 清除所有 Cache Storage
  if ('caches' in window) {
    const cacheNames = await caches.keys();
    for (const name of cacheNames) {
      await caches.delete(name);
      console.log('✅ Cache 已删除:', name);
    }
  }
  
  // 3. 清除 localStorage
  localStorage.clear();
  console.log('✅ localStorage 已清除');
  
  // 4. 清除 sessionStorage
  sessionStorage.clear();
  console.log('✅ sessionStorage 已清除');
  
  // 5. 删除所有 IndexedDB
  if (window.indexedDB) {
    const dbs = await indexedDB.databases();
    for (const db of dbs) {
      indexedDB.deleteDatabase(db.name);
      console.log('✅ IndexedDB 已删除:', db.name);
    }
  }
  
  console.log('🎉 所有缓存已清除!');
  console.log('⚠️ 5秒后将自动刷新页面...');
  
  setTimeout(() => {
    window.location.reload(true);
  }, 5000);
})();
```

### 步骤 3: 验证

刷新后,应该看到:
- ✅ 控制台显示 `📦 当前版本: V260105.10`
- ✅ 不再有 `device_id` 相关的错误
- ✅ 药品同步正常工作

## 为什么会出现这个问题?

1. **Service Worker 缓存**: PWA 的 Service Worker 会缓存旧版本的文件
2. **数据库 Schema 不同步**: 本地代码引用了 `device_id`,但数据库中没有这个列
3. **GitHub Pages 部署延迟**: 可能部署的还是旧版本

## 后续建议

1. **确认 GitHub Pages 部署**: 检查 https://sevenoy.github.io/meds/ 是否已部署最新版本
2. **查看 GitHub Actions**: 确认构建和部署是否成功
3. **使用版本检查**: 应用会在控制台显示版本号,方便确认是否为最新版



