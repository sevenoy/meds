# Realtime 多设备同步测试指南

## 📋 测试目标

验证 Supabase Realtime 多设备即时同步功能的正确性、性能和稳定性。

---

## 🧪 测试环境准备

### 设备要求

至少需要 **2 个设备** 进行测试：
- 设备 A：主设备（例如：电脑）
- 设备 B：从设备（例如：手机/平板/另一台电脑）

### 浏览器要求

- Chrome 90+
- Safari 14+
- Firefox 88+
- Edge 90+

### 网络要求

- 稳定的网络连接
- 支持 WebSocket 协议
- 无防火墙阻止

---

## ✅ Phase 1: 基础功能测试

### 测试 1.1: 连接状态验证

**目标**: 验证 Realtime 连接正常建立

**步骤**:
1. 在设备 A 打开应用并登录
2. 观察右上角同步状态指示器
3. 应该显示 🟢 **已连接**

**预期结果**:
```
✅ 连接状态: 已连接
✅ 控制台日志: [Realtime] 订阅状态: SUBSCRIBED
✅ 无错误信息
```

**失败处理**:
- 如果显示"未连接"，检查 Supabase Realtime 是否已启用
- 查看控制台错误日志
- 尝试点击"重新连接"按钮

---

### 测试 1.2: 药品数据同步

**目标**: 验证药品的增删改操作能实时同步

#### 测试 1.2.1: 添加药品

**步骤**:
1. 设备 A 和设备 B 都打开应用
2. 在设备 A 添加新药品
   - 名称：测试药品 A
   - 剂量：1片
   - 时间：08:00
3. 观察设备 B（无需刷新）

**预期结果**:
```
✅ 设备 B 在 2 秒内自动显示新药品
✅ 设备 B 显示提示："✅ 药品数据已同步"
✅ 药品信息完全一致
```

**验证点**:
- [ ] 药品名称正确
- [ ] 剂量信息正确
- [ ] 时间信息正确
- [ ] 同步延迟 < 2 秒

#### 测试 1.2.2: 修改药品

**步骤**:
1. 在设备 A 编辑刚添加的药品
2. 修改名称为：测试药品 A（已修改）
3. 保存
4. 观察设备 B

**预期结果**:
```
✅ 设备 B 自动更新药品信息
✅ 显示修改后的名称
```

#### 测试 1.2.3: 删除药品

**步骤**:
1. 在设备 A 删除测试药品
2. 观察设备 B

**预期结果**:
```
✅ 设备 B 自动移除该药品
✅ 列表更新正确
```

---

### 测试 1.3: 服药记录同步

**目标**: 验证服药记录能实时同步

**步骤**:
1. 在设备 A 记录一次服药
   - 选择药品
   - 拍照或选择照片
   - 提交记录
2. 观察设备 B

**预期结果**:
```
✅ 设备 B 自动显示新记录
✅ 显示提示："✅ 服药记录已同步"
✅ 记录详情完整（时间、照片等）
```

**验证点**:
- [ ] 记录时间正确
- [ ] 照片正确显示
- [ ] 药品关联正确
- [ ] 同步延迟 < 2 秒

---

### 测试 1.4: 用户设置同步

**目标**: 验证用户设置能实时同步

**步骤**:
1. 在设备 A 修改用户设置
   - 更换头像
   - 修改用户名
2. 观察设备 B

**预期结果**:
```
✅ 设备 B 自动更新头像
✅ 设备 B 自动更新用户名
```

---

## 🔥 Phase 2: 冲突处理测试

### 测试 2.1: 同时修改同一药品

**目标**: 验证 LWW 冲突解决策略

**步骤**:
1. 设备 A 和设备 B 同时编辑同一药品
2. 设备 A 修改名称为：药品 A1
3. 设备 B 修改名称为：药品 B1
4. 设备 A 先保存（T1 时刻）
5. 设备 B 后保存（T2 时刻）
6. 观察两个设备

**预期结果**:
```
✅ 两个设备最终显示相同的数据
✅ 显示后保存的版本（药品 B1）
✅ LWW 策略正确执行
```

**验证点**:
- [ ] 数据一致性
- [ ] 无数据丢失
- [ ] 无错误提示

---

### 测试 2.2: 离线后同步

**目标**: 验证离线场景下的数据同步

**步骤**:
1. 设备 A 断开网络
2. 在设备 A 添加药品（本地存储）
3. 设备 A 恢复网络
4. 观察数据是否同步到设备 B

**预期结果**:
```
✅ 设备 A 恢复网络后自动同步
✅ 设备 B 收到更新
✅ 数据完整无误
```

---

## ⚡ Phase 3: 性能测试

### 测试 3.1: 同步延迟测试

**目标**: 测量实际同步延迟

**步骤**:
1. 在设备 A 添加药品
2. 记录操作时间（T1）
3. 在设备 B 观察到更新时间（T2）
4. 计算延迟：T2 - T1

**预期结果**:
```
✅ 平均延迟 < 2 秒
✅ 95% 延迟 < 3 秒
✅ 最大延迟 < 5 秒
```

**测试数据**（10 次测试）:
| 测试次数 | 延迟（秒） | 状态 |
|---------|-----------|------|
| 1       |           |      |
| 2       |           |      |
| 3       |           |      |
| 4       |           |      |
| 5       |           |      |
| 6       |           |      |
| 7       |           |      |
| 8       |           |      |
| 9       |           |      |
| 10      |           |      |
| **平均** |           |      |

---

### 测试 3.2: 大量数据同步

**目标**: 验证大量数据场景下的性能

**步骤**:
1. 在设备 A 批量导入 50 个药品
2. 观察设备 B 的同步情况
3. 记录同步完成时间

**预期结果**:
```
✅ 所有数据都能同步
✅ 总同步时间 < 10 秒
✅ UI 不卡顿
```

---

### 测试 3.3: 频繁操作测试

**目标**: 验证频繁操作下的稳定性

**步骤**:
1. 在设备 A 快速连续操作：
   - 添加 5 个药品
   - 删除 3 个药品
   - 修改 2 个药品
2. 观察设备 B

**预期结果**:
```
✅ 所有操作都能同步
✅ 数据最终一致
✅ 无错误或丢失
```

---

## 🔄 Phase 4: 稳定性测试

### 测试 4.1: 长时间运行测试

**目标**: 验证长时间运行的稳定性

**步骤**:
1. 保持应用运行 1 小时
2. 期间进行随机操作
3. 观察连接状态和同步情况

**预期结果**:
```
✅ 连接状态始终保持"已连接"
✅ 所有操作都能正常同步
✅ 无内存泄漏
✅ 无性能下降
```

---

### 测试 4.2: 网络波动测试

**目标**: 验证网络不稳定情况下的表现

**步骤**:
1. 模拟网络波动（断开 → 连接 → 断开）
2. 在不同网络状态下进行操作
3. 观察自动重连和数据同步

**预期结果**:
```
✅ 自动重连成功
✅ 离线数据能同步
✅ 显示正确的连接状态
```

---

### 测试 4.3: 多设备并发测试

**目标**: 验证 3+ 设备同时使用的情况

**步骤**:
1. 使用 3 个或更多设备
2. 同时进行不同操作
3. 观察所有设备的同步情况

**预期结果**:
```
✅ 所有设备都能收到更新
✅ 数据最终一致
✅ 无冲突或错误
```

---

## 🐛 Phase 5: 边界测试

### 测试 5.1: 空数据测试

**步骤**:
1. 新用户首次登录（无数据）
2. 在设备 A 添加第一条数据
3. 观察设备 B

**预期结果**:
```
✅ 设备 B 正确显示数据
✅ 无错误
```

---

### 测试 5.2: 特殊字符测试

**步骤**:
1. 添加包含特殊字符的药品名称
   - 表情符号：😊 💊
   - 特殊符号：@#$%^&*
   - 中文、英文、数字混合
2. 观察同步情况

**预期结果**:
```
✅ 特殊字符正确同步
✅ 显示正常
```

---

### 测试 5.3: 快速切换用户

**步骤**:
1. 登录用户 A
2. 添加数据
3. 登出
4. 登录用户 B
5. 观察数据隔离

**预期结果**:
```
✅ 用户 B 看不到用户 A 的数据
✅ 数据隔离正确
✅ Realtime 订阅正确切换
```

---

## 📊 测试报告模板

### 测试摘要

| 项目 | 结果 | 备注 |
|------|------|------|
| 基础功能测试 | ☐ 通过 ☐ 失败 | |
| 冲突处理测试 | ☐ 通过 ☐ 失败 | |
| 性能测试 | ☐ 通过 ☐ 失败 | |
| 稳定性测试 | ☐ 通过 ☐ 失败 | |
| 边界测试 | ☐ 通过 ☐ 失败 | |

### 性能指标

| 指标 | 目标值 | 实际值 | 状态 |
|------|--------|--------|------|
| 平均同步延迟 | < 2s | | |
| 连接成功率 | > 99% | | |
| 数据一致性 | 100% | | |
| 冲突解决率 | > 95% | | |

### 发现的问题

| 问题编号 | 严重程度 | 描述 | 状态 |
|---------|---------|------|------|
| | | | |

### 测试结论

- [ ] 所有测试通过，可以部署
- [ ] 部分测试失败，需要修复
- [ ] 测试未完成，需要继续

---

## 🎯 验收标准

Realtime 多设备同步功能需满足以下标准才能通过验收：

1. ✅ 连接成功率 > 99%
2. ✅ 平均同步延迟 < 2 秒
3. ✅ 数据一致性 100%
4. ✅ 冲突自动解决率 > 95%
5. ✅ 支持 3+ 设备同时使用
6. ✅ 自动重连机制工作正常
7. ✅ 用户数据隔离正确
8. ✅ 无内存泄漏
9. ✅ UI 响应流畅
10. ✅ 错误处理完善

---

**测试人员**: ___________  
**测试日期**: ___________  
**测试版本**: Meds V251219.42+  
**测试结果**: ☐ 通过 ☐ 失败

