# 🐛 V260105.06 - 服药记录同步修复

## 📋 问题描述

**用户反馈:**
- 电脑端: 3个药品, 8条记录 ✅
- 手机端: 3个药品, 0条记录 ❌

**现象:**
- 药品数据同步正常
- 服药记录**不同步**

---

## 🔍 根本原因

### 问题代码

**App.tsx - loadData() 函数:**

```typescript
// ❌ 错误: 只拉取数据,但没有保存到本地
try {
  console.log('☁️ 从云端拉取最新数据...');
  await pullRemoteChanges(); // 返回数组,但没有处理!
  console.log('✅ 云端数据已同步到本地');
} catch (syncError) {
  console.warn('⚠️ 云端同步失败:', syncError);
}
```

### pullRemoteChanges() 的工作方式

**src/services/sync.ts:**

```typescript
export async function pullRemoteChanges(): Promise<MedicationLog[]> {
  // 1. 从 Supabase 查询服药记录
  const { data } = await supabase
    .from('medication_logs')
    .select('*')
    .eq('user_id', userId);
  
  // 2. 返回记录数组
  return (data || []).map(log => ({
    ...log,
    sync_state: 'clean'
  }));
}
```

**问题:**
- 函数**返回**了数据,但**没有自动保存**到本地数据库
- 需要手动调用 `mergeRemoteLog()` 来保存

---

## ✅ 修复方案

### 修复1: loadData() 函数

**修复前:**
```typescript
await pullRemoteChanges(); // ❌ 返回值被忽略
```

**修复后:**
```typescript
// ✅ 处理返回的数据
const remoteLogs = await pullRemoteChanges();
console.log(`📥 从云端拉取到 ${remoteLogs.length} 条服药记录`);

// ✅ 合并到本地数据库
for (const log of remoteLogs) {
  await mergeRemoteLog(log);
}
```

---

### 修复2: Realtime 回调

**onMedicationChange:**

```typescript
// 修复前
await pullRemoteChanges(); // ❌ 返回值被忽略
await loadData();

// 修复后
await syncMedications(); // ✅ 同步药品
const remoteLogs = await pullRemoteChanges(); // ✅ 拉取记录
for (const log of remoteLogs) { // ✅ 保存到本地
  await mergeRemoteLog(log);
}
await loadData();
```

**onLogChange:** 同上

---

## 🔧 完整的同步流程

### 修复后的流程:

```
loadData() 被调用
    ↓
1. 调用 syncMedications()
    → 推送本地药品到 Supabase
    → 拉取云端药品到本地
    ↓
2. 调用 pullRemoteChanges()
    → 从 Supabase 查询服药记录
    → 返回记录数组
    ↓
3. 遍历记录数组
    → 对每条记录调用 mergeRemoteLog()
    → 保存到本地 IndexedDB
    ↓
4. 调用 getMedicationLogs()
    → 从本地 IndexedDB 读取
    → 更新 UI
    ↓
✅ 所有数据同步完成
```

---

## 📊 mergeRemoteLog() 的作用

**src/services/sync.ts:**

```typescript
export async function mergeRemoteLog(log: MedicationLog): Promise<void> {
  const existing = await db.medicationLogs.get(log.id);
  
  if (!existing) {
    // 新记录，直接添加到本地数据库
    await db.medicationLogs.add({
      ...log,
      sync_state: 'clean'
    });
    return;
  }
  
  // 检测冲突
  const conflict = detectConflict(existing, log);
  if (conflict) {
    // 标记为冲突
    await db.medicationLogs.update(existing.id, {
      sync_state: 'conflict'
    });
    return;
  }
  
  // 无冲突，更新本地记录
  await markLogSynced(existing.id, log);
}
```

**作用:**
- 检查本地是否已有该记录
- 如果没有,添加到本地数据库
- 如果有,检测冲突并合并
- 最终保存到 IndexedDB

---

## 🧪 测试验证

### 测试1: 手机端刷新

**操作:**
1. 手机端清除缓存
2. 刷新页面
3. 查看控制台

**预期日志:**
```
🔄 开始加载数据...
☁️ 从云端拉取最新数据...
📥 从云端拉取到 8 条服药记录  ← 关键!
✅ 云端数据已同步到本地
📋 已加载 3 个药物
```

**预期结果:**
- 手机端显示 3个药品, 8条记录 ✅
- 数据诊断显示:
  ```
  本地数据库: 3 个药品, 8 条记录
  当前显示: 3 个药品, 8 条记录
  ```

---

### 测试2: 实时同步

**操作:**
1. 电脑端添加新的服药记录
2. 手机端观察 (不刷新)

**预期行为:**
1. 1-2秒内,手机端自动显示蓝色通知
2. 记录数量自动增加

**预期日志 (手机端):**
```
[Realtime] 服药记录变更 {eventType: "INSERT"}
🔔 检测到服药记录变更,从云端重新加载...
📥 从云端拉取到 9 条服药记录
✅ 云端数据已同步到本地
```

---

### 测试3: 数据一致性

**操作:**
- 打开3个设备
- 所有设备点击 "数据诊断"

**预期结果:**
- 所有设备显示相同的数字:
  ```
  设备A: 3 个药品, 8 条记录
  设备B: 3 个药品, 8 条记录
  设备C: 3 个药品, 8 条记录
  ```

---

## 🔍 为什么药品能同步,但记录不能?

### 药品同步逻辑

**syncMedications():**
```typescript
export async function syncMedications(): Promise<void> {
  // 1. 推送本地药品
  for (const med of localMeds) {
    await supabase.from('medications').upsert(med);
  }
  
  // 2. 拉取云端药品
  const { data: cloudMeds } = await supabase
    .from('medications')
    .select('*');
  
  // 3. 自动保存到本地 ✅
  for (const cloudMed of cloudMeds) {
    await upsertMedication(cloudMed); // 直接保存!
  }
}
```

**关键:** `syncMedications()` 内部**自动**调用 `upsertMedication()` 保存到本地

---

### 服药记录同步逻辑 (修复前)

**pullRemoteChanges():**
```typescript
export async function pullRemoteChanges(): Promise<MedicationLog[]> {
  // 1. 拉取云端记录
  const { data } = await supabase
    .from('medication_logs')
    .select('*');
  
  // 2. 返回数据 (没有自动保存!) ❌
  return data || [];
}
```

**问题:** 
- 只返回数据,**不自动保存**
- 调用者必须手动调用 `mergeRemoteLog()`
- 我们之前**忘记了**这一步!

---

## 📝 修复总结

### 修改的文件

1. **App.tsx**
   - `loadData()` 函数
   - `onMedicationChange` 回调
   - `onLogChange` 回调

### 修改的逻辑

**之前:**
```typescript
await pullRemoteChanges(); // 返回值被忽略 ❌
```

**现在:**
```typescript
// 1. 同步药品
await syncMedications();

// 2. 拉取记录
const remoteLogs = await pullRemoteChanges();

// 3. 保存到本地 ✅
for (const log of remoteLogs) {
  await mergeRemoteLog(log);
}
```

---

## 🎯 修复效果

### 修复前
- ❌ 手机端服药记录为空
- ❌ 只有电脑端有记录
- ❌ 数据不一致

### 修复后
- ✅ 所有设备显示相同的记录
- ✅ 手机端刷新后自动加载所有记录
- ✅ 新记录1-2秒内自动同步
- ✅ 数据完全一致

---

## 🚀 部署步骤

### 1. 更新代码

**已推送到 GitHub:**
```
✅ Git 提交: c78406b
✅ 版本号: V260105.06
```

### 2. 清除缓存

**所有设备:**
1. 进入 "我的" 页面
2. 点击 "清除缓存"
3. 确认版本号显示 `V260105.06`

### 3. 验证同步

**手机端:**
1. 刷新页面
2. 查看控制台,应该显示:
   ```
   📥 从云端拉取到 8 条服药记录
   ```
3. 点击 "数据诊断"
4. 应该显示:
   ```
   本地数据库: 3 个药品, 8 条记录
   ```

**如果还是0条记录:**
- 查看控制台是否有错误
- 确认 Supabase 中确实有记录:
  ```sql
  SELECT COUNT(*) FROM medication_logs WHERE user_id = '...';
  ```

---

## 🔍 故障排查

### 问题1: 手机端还是0条记录

**可能原因:**
- 缓存未清除
- pullRemoteChanges() 返回空数组

**解决方法:**

1. **检查控制台日志:**
   ```
   📥 从云端拉取到 X 条服药记录
   ```
   - 如果 X = 0,说明 Supabase 中没有数据
   - 如果 X > 0,继续下一步

2. **检查是否保存到本地:**
   ```javascript
   // 在控制台执行
   const logs = await db.medicationLogs.toArray();
   console.log('本地记录数:', logs.length);
   ```

3. **手动同步:**
   - 进入 "我的" 页面
   - 找到 "手动同步" 按钮 (如果有)
   - 或者点击刷新按钮

---

### 问题2: Supabase 中没有记录

**检查:**
```sql
-- 在 Supabase SQL Editor 执行
SELECT * FROM medication_logs 
WHERE user_id = 'YOUR_USER_ID' 
ORDER BY created_at DESC;
```

**如果返回空:**
- 说明电脑端的记录**没有同步到 Supabase**
- 检查电脑端的 `pushLocalChanges()` 是否正常执行

---

### 问题3: mergeRemoteLog() 失败

**症状:**
- 控制台显示 "📥 从云端拉取到 8 条"
- 但数据诊断显示 0 条

**解决方法:**

1. **查看完整的错误日志**
2. **检查 medication_id:**
   - 服药记录的 `medication_id` 必须匹配本地药品的 `id`
   - 如果不匹配,记录可能被忽略

3. **清空本地数据库,重新同步:**
   ```javascript
   // 在控制台执行
   await db.medicationLogs.clear();
   await pullRemoteChanges().then(logs => {
     for (const log of logs) {
       db.medicationLogs.add(log);
     }
   });
   ```

---

## 📊 版本信息

- **修复版本**: V260105.06
- **修复日期**: 2026年1月5日
- **修复类型**: Bug Fix (Critical)
- **影响范围**: 服药记录同步

---

## ✅ 修复确认

- [x] 修复 loadData() 函数
- [x] 修复 onMedicationChange 回调
- [x] 修复 onLogChange 回调
- [x] 添加 mergeRemoteLog() 调用
- [x] 添加详细的控制台日志
- [x] 通过 Linter 检查
- [x] 更新版本号为 V260105.06
- [x] 推送到 GitHub

---

**服药记录同步问题已修复! 所有设备将显示相同的记录!** 🎉

---

© 2026 药盒助手 V260105.06 | 服药记录同步修复版本



