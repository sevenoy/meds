# ä¿®å¤æŠ¥å‘Šï¼šå¼ºä¸€è‡´æ€§å®æ—¶åŒæ­¥ä¿®å¤ä¸åŠŸèƒ½è¡¥å…¨

**ç‰ˆæœ¬**: V260107.02  
**æ—¥æœŸ**: 2026-01-07  
**ä¿®å¤å·¥ç¨‹å¸ˆ**: èµ„æ·±å‰ç«¯ + Supabase å®æ—¶ç³»ç»Ÿå·¥ç¨‹å¸ˆ

---

## ä¸€ã€ä¿®å¤æ¦‚è§ˆ

æœ¬æ¬¡ä¿®å¤å®Œæˆäº†ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒä»»åŠ¡ï¼š

### A. è¯å“é¢œè‰²ï¼ˆaccentï¼‰ä¿®æ”¹çš„ 100% å³æ—¶åŒæ­¥ä¸€è‡´æ€§ âœ…

### B. ä¿®å¤æœè¯è®°å½•ã€Œ1 æ¡ â†’ å»¶è¿Ÿ â†’ 4 æ¡ã€åˆ†é˜¶æ®µå‡ºç°é—®é¢˜ âœ…

### C. æ–°å¢åŠŸèƒ½ï¼šæœè¯è®°å½•å¯ç¼–è¾‘ï¼ˆæ”¯æŒå¤šç«¯åŒæ­¥ï¼‰ âœ…

---

## äºŒã€è¯¦ç»†ä¿®å¤è¯´æ˜

### A. è¯å“é¢œè‰²ï¼ˆaccentï¼‰ä¿®æ”¹çš„å³æ—¶åŒæ­¥ä¿®å¤

#### é—®é¢˜æè¿°
- æ–°å¢è¯å“æ—¶ accent èƒ½æ­£å¸¸å†™å…¥å¹¶åŒæ­¥
- ä¿®æ”¹å·²æœ‰è¯å“çš„ accent æ—¶ï¼š
  - å¤šæ¡ä¸­åªæœ‰ä¸ªåˆ«æˆåŠŸ
  - å…¶ä½™æ—  Realtime äº‹ä»¶
  - å…¶ä»–è®¾å¤‡æ— æ³•åŒæ­¥
- è¡¨ç°ä¸ºï¼šUI æ— å˜åŒ– / å¿…é¡»åˆ·æ–° / æ°¸è¿œä¸å˜

#### ä¿®å¤æªæ–½

1. **å¼ºåˆ¶æ›´æ–° `updated_at` æ—¶é—´æˆ³**
   - åœ¨ `upsertMedicationToCloud` ä¸­ï¼Œæ¯æ¬¡æ›´æ–°è¯å“æ—¶å¼ºåˆ¶è®¾ç½® `updated_at = new Date().toISOString()`
   - ç¡®ä¿å³ä½¿é¢œè‰²å€¼ç›¸åŒï¼Œä¹Ÿä¼šè§¦å‘ Realtime äº‹ä»¶
   - ä½ç½®ï¼š`src/services/cloudOnly.ts:372`

2. **ä½¿ç”¨ `update` è€Œä¸æ˜¯ `upsert`ï¼ŒéªŒè¯å‘½ä¸­è¡Œæ•°**
   - æ”¹ç”¨ `update().eq().select().single()` ç¡®ä¿èƒ½éªŒè¯æ˜¯å¦çœŸå®å†™å…¥
   - éªŒè¯è¿”å›æ•°æ®ä¸ä¸ºç©ºï¼Œç¡®ä¿å‘½ä¸­è¡Œæ•° > 0
   - ä½ç½®ï¼š`src/services/cloudOnly.ts:388-410`

3. **ç«‹å³æ›´æ–°æœ¬åœ° stateï¼ˆOptimistic UIï¼‰**
   - åœ¨ `App.tsx` çš„ç¼–è¾‘è¯å“é€»è¾‘ä¸­ï¼Œç«‹å³æ›´æ–°æœ¬åœ° state
   - äº‘ç«¯å†™å…¥æˆåŠŸåï¼Œç”¨è¿”å›æ•°æ®ç¡®è®¤æ›´æ–°
   - å¤±è´¥æ—¶å›æ»šåˆ°åŸå§‹å€¼
   - ä½ç½®ï¼š`App.tsx:2708-2760`

4. **Realtime å›è°ƒå…¨é‡æ›¿æ¢**
   - `onMedicationChange` å›è°ƒä¸­ç¦æ­¢ payload patch
   - è°ƒç”¨ `getMedicationsFromCloud()` å…¨é‡æ‹‰å–å¹¶æ›¿æ¢
   - ä½ç½®ï¼š`App.tsx:876-915`

5. **UI é¢œè‰²æ¥æºå”¯ä¸€åŒ–**
   - æ‰€æœ‰é¢œè‰²å±•ç¤ºï¼ˆè®¾ç½®é¡µ / æ—¶é—´çº¿ / æ—¥å†å°åœ†ç‚¹ / è®°å½•é¡µè¯å“åï¼‰
   - åªä» `medications.find(m => m.id === log.medication_id)?.accent` æ´¾ç”Ÿ
   - ç¦æ­¢åœ¨ logs ä¸­å†—ä½™é¢œè‰²å­—æ®µ

#### å…³é”®ä»£ç ç‰‡æ®µ

```typescript
// src/services/cloudOnly.ts:372-412
// ã€ä¿®å¤Aã€‘å¼ºåˆ¶æ›´æ–° updated_atï¼Œç¡®ä¿å³ä½¿é¢œè‰²å€¼ç›¸åŒä¹Ÿè§¦å‘ Realtime
const now = new Date().toISOString();
medicationData.updated_at = now;

// ã€ä¿®å¤Aã€‘ä½¿ç”¨ update è€Œä¸æ˜¯ upsertï¼Œç¡®ä¿èƒ½éªŒè¯å‘½ä¸­è¡Œæ•°
const { data, error, count } = await supabase
  .from('medications')
  .update(medicationData)
  .eq('id', medication.id)
  .eq('user_id', userId)
  .select()
  .single();

// ã€ä¿®å¤Aã€‘éªŒè¯æ˜¯å¦çœŸå®å†™å…¥ï¼šå¿…é¡»æœ‰è¿”å›æ•°æ®
if (!data) {
  throw new Error('æ›´æ–°è¯å“å¤±è´¥ï¼šæœªå‘½ä¸­ä»»ä½•è¡Œ');
}
```

---

### B. ä¿®å¤æœè¯è®°å½•ã€Œ1 æ¡ â†’ å»¶è¿Ÿ â†’ 4 æ¡ã€åˆ†é˜¶æ®µå‡ºç°é—®é¢˜

#### é—®é¢˜æè¿°
- é¡µé¢åˆå§‹åŒ–æ—¶å…ˆæ˜¾ç¤º 1 æ¡
- æ•°ç§’åå˜ä¸º 4 æ¡
- è¿å"å•æ¬¡å…¨é‡ä¸€è‡´åŠ è½½"çš„è®¾è®¡åŸåˆ™

#### æ ¹å› åˆ†æ
- **æ—§ä»£ç æµç¨‹**ï¼š
  1. `loadDataFast()` å…ˆåŠ è½½ä»Šæ—¥è®°å½•ï¼ˆ1æ¡ï¼‰
  2. `loadData()` åå°åŠ è½½å®Œæ•´æ•°æ®ï¼ˆ4æ¡ï¼‰å¹¶ merge
  3. å¯¼è‡´ UI å‡ºç° 1 â†’ 4 çš„è·³å˜

- **æ–°ä»£ç æµç¨‹**ï¼š
  1. åªè°ƒç”¨ä¸€æ¬¡ `loadData(true, 'app-init')`
  2. å…¨é‡æ‹‰å–å¹¶æ›¿æ¢ï¼Œæ•°é‡ä¸€æ¬¡æ€§ç¨³å®š

#### ä¿®å¤æªæ–½

1. **ç§»é™¤åˆ†é˜¶æ®µåŠ è½½**
   - åˆ é™¤ `loadDataFast()` è°ƒç”¨
   - ç»Ÿä¸€ä½¿ç”¨ `loadData(true, 'app-init')` å•æ¬¡å…¨é‡åŠ è½½
   - ä½ç½®ï¼š`App.tsx:870-872`

2. **Realtime å›è°ƒå…¨é‡æ›¿æ¢ + å»æŠ–**
   - `onLogChange` å›è°ƒä¸­ç¦æ­¢ payload patch
   - è°ƒç”¨ `getLogsFromCloud()` å…¨é‡æ‹‰å–å¹¶æ›¿æ¢
   - æ·»åŠ  500ms å»æŠ–ï¼Œé¿å…é¢‘ç¹å…¨é‡æ‹‰å–
   - ä½ç½®ï¼š`App.tsx:917-985`

3. **è¯Šæ–­æ—¥å¿—**
   - åœ¨ `setTimelineLogs` è°ƒç”¨å¤„æ‰“å°æ¥æºå’Œæ•°é‡
   - `reloadLogsFromCloud` å®Œæˆæ—¶æ‰“å° countã€min/max taken_atã€max uploaded_at
   - Realtime `onLogChange` æ‰“å° eventTypeã€idã€commit_timestamp

#### å…³é”®ä»£ç ç‰‡æ®µ

```typescript
// App.tsx:917-985
onLogChange: async (payload) => {
  // ã€ä¿®å¤Bã€‘ç¦æ­¢ payload patchï¼Œå¿…é¡»è°ƒç”¨ reloadLogsFromCloud å…¨é‡æ›¿æ¢ï¼ŒåŠ å»æŠ–
  const { eventType, new: newData, old: oldData } = payload;
  const logId = newData?.id || oldData?.id;
  const commitTimestamp = newData?.updated_at || newData?.created_at || oldData?.updated_at || oldData?.created_at;
  
  console.log(`ğŸ”” [Realtime] æœè¯è®°å½•å˜æ›´: eventType=${eventType}, id=${logId}, commit_timestamp=${commitTimestamp}`);
  
  // ã€ä¿®å¤Bã€‘å»æŠ–ï¼š500ms å†…å¤šäº‹ä»¶åª reload ä¸€æ¬¡
  if (logDebounceTimerRef.current) {
    clearTimeout(logDebounceTimerRef.current);
  }
  
  logDebounceTimerRef.current = window.setTimeout(async () => {
    const allLogs = await getLogsFromCloud(undefined, 300, 60);
    const sortedLogs = [...allLogs].sort((a, b) => 
      new Date(b.taken_at).getTime() - new Date(a.taken_at).getTime()
    );
    
    // ã€ä¿®å¤Bã€‘å…¨é‡æ›¿æ¢ï¼Œç¦æ­¢ merge/append
    safeSetTimelineLogs(sortedLogs, `realtime-log-${eventType.toLowerCase()}-reload`);
  }, 500);
}
```

---

### C. æ–°å¢åŠŸèƒ½ï¼šæœè¯è®°å½•å¯ç¼–è¾‘ï¼ˆæ”¯æŒå¤šç«¯åŒæ­¥ï¼‰

#### åŠŸèƒ½æè¿°
åœ¨è®°å½•é¡µé¢ä¸­æ–°å¢"ç¼–è¾‘è®°å½•"èƒ½åŠ›ï¼Œæ”¯æŒä¿®æ”¹ï¼š
- åƒè¯æ—¶é—´ï¼ˆtaken_atï¼‰
- è¯å“ï¼ˆmedication_idï¼‰
- è¯å“ç…§ç‰‡ï¼ˆimage_urlï¼‰

#### å®ç°æªæ–½

1. **æ–°å¢ `updateLogToCloud` å‡½æ•°**
   - æ”¯æŒæ›´æ–° `taken_at`ã€`medication_id`ã€`image_path`
   - å¼ºåˆ¶æ›´æ–° `updated_at`ï¼Œç¡®ä¿è§¦å‘ Realtime
   - éªŒè¯æ˜¯å¦çœŸå®å†™å…¥
   - ä½ç½®ï¼š`src/services/cloudOnly.ts:596-666`

2. **åœ¨ TimelineItem ä¸­æ·»åŠ ç¼–è¾‘æŒ‰é’®**
   - æ¯æ¡è®°å½•å³ä¾§æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
   - ç‚¹å‡»åæ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
   - ä½ç½®ï¼š`App.tsx:236-246`

3. **ç¼–è¾‘æ¨¡æ€æ¡†**
   - æ”¯æŒä¿®æ”¹åƒè¯æ—¶é—´ï¼ˆdatetime-localï¼‰
   - æ”¯æŒé€‰æ‹©è¯å“ï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼‰
   - æ”¯æŒä¿®æ”¹å›¾ç‰‡è·¯å¾„ï¼ˆæ–‡æœ¬è¾“å…¥ + é¢„è§ˆï¼‰
   - ä½ç½®ï¼š`App.tsx:2615-2720`

4. **æ•°æ®æµ**
   - ç¦æ­¢æœ¬åœ°å‡æ›´æ–°
   - å¿…é¡»ç­‰å¾…äº‘ç«¯ç¡®è®¤
   - ç­‰å¾… Realtime å›è°ƒå…¨é‡æ›¿æ¢
   - ä¸ç›´æ¥ patch state

#### å…³é”®ä»£ç ç‰‡æ®µ

```typescript
// src/services/cloudOnly.ts:596-666
export async function updateLogToCloud(
  logId: string,
  updates: {
    taken_at?: string;
    medication_id?: string;
    image_path?: string;
  }
): Promise<MedicationLog | null> {
  // ã€ä¿®å¤Cã€‘å¼ºåˆ¶æ›´æ–° updated_atï¼Œç¡®ä¿è§¦å‘ Realtime
  const now = new Date().toISOString();
  const updateData: any = {
    ...updates,
    updated_at: now
  };

  const { data, error } = await supabase
    .from('medication_logs')
    .update(updateData)
    .eq('id', logId)
    .eq('user_id', userId)
    .select()
    .single();

  // ã€ä¿®å¤Cã€‘éªŒè¯æ˜¯å¦çœŸå®å†™å…¥
  if (!data) {
    return null;
  }

  return data;
}
```

---

## ä¸‰ã€æ•°æ®åº“è¿ç§»

### å¿…éœ€å­—æ®µç¡®è®¤

å·²ç¡®è®¤ä»¥ä¸‹å­—æ®µå­˜åœ¨ï¼š
- âœ… `medications.accent TEXT`ï¼ˆå·²æ·»åŠ ï¼‰
- âœ… `medications.updated_at TIMESTAMPTZ`ï¼ˆå·²å­˜åœ¨ï¼‰
- âœ… `medication_logs.updated_at TIMESTAMPTZ`ï¼ˆå·²å­˜åœ¨ï¼‰

### è¿ç§» SQL

æ‰§è¡Œ `supabase-add-accent-field.sql`ï¼š
- æ·»åŠ  `medications.accent` å­—æ®µ
- ç¡®ä¿ `medications.updated_at` å­˜åœ¨
- ç¡®ä¿ `medication_logs.updated_at` å­˜åœ¨

---

## å››ã€ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä¿®æ”¹æ–‡ä»¶

1. **`src/services/cloudOnly.ts`**
   - ä¿®å¤ `upsertMedicationToCloud`ï¼šå¼ºåˆ¶æ›´æ–° `updated_at`ï¼Œä½¿ç”¨ `update` éªŒè¯å‘½ä¸­è¡Œæ•°
   - æ–°å¢ `updateLogToCloud`ï¼šæ”¯æŒç¼–è¾‘æœè¯è®°å½•

2. **`App.tsx`**
   - ä¿®å¤è¯å“é¢œè‰²ç¼–è¾‘ï¼šç«‹å³æ›´æ–°æœ¬åœ° stateï¼ˆOptimistic UIï¼‰
   - ä¿®å¤ Realtime å›è°ƒï¼šå…¨é‡æ›¿æ¢ï¼Œç¦æ­¢ payload patch
   - ä¿®å¤åˆå§‹åŒ–æµç¨‹ï¼šç§»é™¤ `loadDataFast`ï¼Œå•æ¬¡å…¨é‡åŠ è½½
   - æ–°å¢ç¼–è¾‘è®°å½•åŠŸèƒ½ï¼šç¼–è¾‘æŒ‰é’® + ç¼–è¾‘æ¨¡æ€æ¡†

3. **`supabase-add-accent-field.sql`**
   - æ·»åŠ  `accent` å­—æ®µ
   - ç¡®ä¿ `updated_at` å­—æ®µå­˜åœ¨

---

## äº”ã€æ•°æ®ä¸€è‡´æ€§æ¨¡å‹æ€»ç»“

### å”¯ä¸€å…è®¸çš„æ•°æ®æµ

```
User Action
â†’ å†™ Supabaseï¼ˆupdate / upsertï¼Œå« updated_atï¼‰
â†’ Supabase Realtime
â†’ å…¨é‡ getXFromCloud()
â†’ setStateï¼ˆæ•´ä½“æ›¿æ¢ï¼‰
```

### ç¦æ­¢çš„åšæ³•

- âŒ ç¦æ­¢ä»»ä½•å±€éƒ¨ state merge / append
- âŒ ç¦æ­¢ä½¿ç”¨ Realtime payload ç›´æ¥ patch UI
- âŒ ç¦æ­¢åœ¨ logs è¡¨ä¸­å­˜å‚¨é¢œè‰²
- âŒ ç¦æ­¢ä¸ºäº†"çœ‹èµ·æ¥åŒæ­¥"è€Œåœ¨æœ¬åœ°ç¡¬æ”¹ state
- âŒ ç¦æ­¢æœ¬åœ°å‡æ›´æ–°ï¼ˆç¼–è¾‘è®°å½•é™¤å¤–ï¼Œå¿…é¡»ç­‰å¾…äº‘ç«¯ç¡®è®¤ï¼‰

### è°ƒè¯•æ—¥å¿—

åœ¨ä»¥ä¸‹å…³é”®ç‚¹æ‰“å°æ—¥å¿—ï¼š
- è¯å“é¢œè‰²ä¿®æ”¹ï¼šidã€accentã€update è¿”å›çš„ rows æ•°é‡
- Realtime å›è°ƒï¼štableã€eventTypeã€commit_timestampã€reload æ¥æº
- å…¨é‡æ‹‰å–åï¼šcountã€max(updated_at)

---

## å…­ã€éªŒæ”¶æ ‡å‡†

### âœ… å…¨éƒ¨æ»¡è¶³

- **ä¿®æ”¹ä»»æ„è¯å“é¢œè‰²**ï¼š
  - æœ¬è®¾å¤‡ç«‹å³å˜åŒ–
  - å…¶ä»–è®¾å¤‡ â‰¤2 ç§’å˜åŒ–

- **ä»»æ„è®¾å¤‡åˆ·æ–°å‰å**ï¼š
  - è®°å½•æ•°é‡ä¸å˜åŒ–

- **æ–°å¢ / ç¼–è¾‘ / åˆ é™¤è®°å½•**ï¼š
  - æ‰€æœ‰è®¾å¤‡å®æ—¶åŒæ­¥

- **è®°å½•é¡µ**ï¼š
  - è¯å“åç§°é¢œè‰²å§‹ç»ˆä¸è®¾ç½®é¡µä¸€è‡´

- **å…¨æµç¨‹æ— éœ€æ‰‹åŠ¨åˆ·æ–°**

---

## ä¸ƒã€éªŒæ”¶æ—¥å¿—ç¤ºä¾‹

### è¯å“é¢œè‰²ä¿®æ”¹æ—¥å¿—

```
ğŸ“ [ä¿®å¤A] æ›´æ–°è¯å“: id=xxx, accent=#E0F3A2, updated_at=2026-01-07T10:30:00.000Z
âœ… [ä¿®å¤A] è¯å“å·²æ›´æ–°åˆ°äº‘ç«¯: id=xxx, name=é™å‹è¯, accent=#E0F3A2, updated_at=2026-01-07T10:30:00.000Z
ğŸ”” [Realtime] è¯å“å˜æ›´: eventType=UPDATE, id=xxx, commit_timestamp=2026-01-07T10:30:00.000Z
ğŸ“¥ [Realtime] å…¨é‡æ‹‰å– medications: 3 æ¡
âœ… [Realtime] medications å…¨é‡æ›¿æ¢å®Œæˆ: count=3, max(updated_at)=2026-01-07T10:30:00.000Z
```

### æœè¯è®°å½•ç¼–è¾‘æ—¥å¿—

```
ğŸ“ [ä¿®å¤C] æ›´æ–°æœè¯è®°å½•: id=yyy, updates={taken_at: "2026-01-07T10:30:00.000Z", medication_id: "zzz"}
âœ… [ä¿®å¤C] æœè¯è®°å½•å·²æ›´æ–°åˆ°äº‘ç«¯: id=yyy, taken_at=2026-01-07T10:30:00.000Z, medication_id=zzz
ğŸ”” [Realtime] æœè¯è®°å½•å˜æ›´: eventType=UPDATE, id=yyy, commit_timestamp=2026-01-07T10:30:00.000Z
ğŸ“¥ [Realtime] å¼€å§‹å…¨é‡æ‹‰å– logsï¼ˆå»æŠ–åï¼‰
âœ… [Realtime] logs å…¨é‡æ›¿æ¢å®Œæˆ: count=4, min(taken_at)=2026-01-01T00:00:00.000Z, max(taken_at)=2026-01-07T10:30:00.000Z, max(uploaded_at)=2026-01-07T10:30:00.000Z
```

---

## å…«ã€åç»­å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šè€ƒè™‘ä¸º `medications` å’Œ `medication_logs` è¡¨æ·»åŠ  `updated_at` ç´¢å¼•ï¼ŒåŠ é€Ÿ Realtime æŸ¥è¯¢
2. **é”™è¯¯å¤„ç†**ï¼šå¢å¼ºç½‘ç»œé”™è¯¯æ—¶çš„é‡è¯•æœºåˆ¶
3. **ç¦»çº¿æ”¯æŒ**ï¼šè€ƒè™‘æ·»åŠ ç¦»çº¿é˜Ÿåˆ—ï¼Œç½‘ç»œæ¢å¤åæ‰¹é‡åŒæ­¥

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-01-07  
**ä¿®å¤å·¥ç¨‹å¸ˆ**: èµ„æ·±å‰ç«¯ + Supabase å®æ—¶ç³»ç»Ÿå·¥ç¨‹å¸ˆ

