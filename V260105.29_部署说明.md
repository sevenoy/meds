# V260105.29 部署说明 - 强制版本同步 + 云端化架构

## 🚨 重要变更

这是一个**架构级别的重大更新**，实现了：
1. **强制版本同步**：所有设备必须使用相同版本，版本不一致会自动清除缓存并刷新
2. **纯云端服务**：新增 `cloudOnly.ts`，为后续完全移除 IndexedDB 做准备

---

## 📋 部署步骤

### 1. 执行数据库迁移脚本

在 Supabase Dashboard 的 SQL Editor 中执行：

```sql
-- 文件：强制版本同步_云端化迁移.sql

-- 1. 在 app_state 表添加 required_version 字段
ALTER TABLE app_state 
ADD COLUMN IF NOT EXISTS required_version TEXT;

-- 2. 设置当前最新版本（所有设备必须更新到此版本）
UPDATE app_state 
SET required_version = 'V260105.29'
WHERE required_version IS NULL;

-- 3. 添加 medications 表缺失字段
ALTER TABLE medications 
ADD COLUMN IF NOT EXISTS accent TEXT,
ADD COLUMN IF NOT EXISTS device_id TEXT;

-- 4. 添加 medication_logs 表缺失字段
ALTER TABLE medication_logs 
ADD COLUMN IF NOT EXISTS device_id TEXT;

-- 5. 创建索引优化查询性能
CREATE INDEX IF NOT EXISTS idx_medications_user_device ON medications(user_id, device_id);
CREATE INDEX IF NOT EXISTS idx_medication_logs_user_device ON medication_logs(user_id, device_id);
CREATE INDEX IF NOT EXISTS idx_app_state_required_version ON app_state(required_version);
```

### 2. 推送代码到 GitHub

```bash
git push origin main
```

### 3. 等待 GitHub Pages 部署完成（约 1-2 分钟）

---

## 🔍 版本同步机制

### 工作原理

1. **用户登录时**：
   - 前端读取 `app_state.required_version`
   - 如果云端版本 ≠ 当前版本（V260105.29），触发强制更新

2. **强制更新流程**：
   ```
   检测版本不一致
   ↓
   清除所有缓存（Service Worker、localStorage、sessionStorage、IndexedDB）
   ↓
   显示提示："检测到新版本 Vxxx，即将自动更新..."
   ↓
   强制刷新页面
   ```

3. **首次设置**：
   - 如果云端没有 `required_version`，自动设置为当前版本

---

## 📱 用户体验

### 正常情况
- 所有设备版本一致 → 正常使用，无感知

### 版本不一致时
- 旧版本设备登录 → 自动弹出提示 → 自动刷新 → 更新到最新版本

---

## 🛠️ 后续计划

当前版本（V260105.29）已经添加了 `cloudOnly.ts` 纯云端服务，但**尚未完全启用**。

后续版本将：
1. 将所有 `getMedications()` 替换为 `getMedicationsFromCloud()`
2. 将所有 `getMedicationLogs()` 替换为 `getLogsFromCloud()`
3. 将所有 `upsertMedication()` 替换为 `upsertMedicationToCloud()`
4. 完全移除 IndexedDB 依赖

---

## ⚠️ 注意事项

1. **必须先执行 SQL 迁移**，否则版本检查会失败
2. **所有设备会在首次登录时自动更新**，无需手动操作
3. **如果用户反馈"一直刷新"**，检查 `app_state.required_version` 是否正确设置为 `V260105.29`

---

## 🐛 故障排查

### 问题：设备一直刷新，无法进入应用

**原因**：`app_state.required_version` 未正确设置

**解决方案**：
```sql
-- 在 Supabase SQL Editor 执行
UPDATE app_state 
SET required_version = 'V260105.29';
```

### 问题：部分设备仍显示旧版本

**原因**：Service Worker 缓存未清除

**解决方案**：
1. 用户手动清除浏览器缓存
2. 或等待下次登录时自动触发版本检查

---

## 📊 监控指标

部署后，关注以下日志：
- `✅ 版本检查通过` - 版本一致，正常使用
- `🚨 版本不一致，强制更新!` - 触发了强制更新
- `✅ 已清除 Service Worker 缓存` - 缓存清理成功

---

## 📞 联系方式

如有问题，请查看控制台日志并提供：
1. 当前版本号（控制台显示）
2. 云端 required_version（Supabase 查询）
3. 完整错误日志

