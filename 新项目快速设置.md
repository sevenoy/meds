# 🚀 新 Supabase 项目快速设置

## ✅ 已完成

- ✅ 创建新 Supabase 项目：`vcoioqystzyztgrgesjw`
- ✅ 更新应用配置
- ✅ 重新构建应用
- ✅ 推送到 GitHub

---

## ⚠️ 重要：需要执行数据库迁移

新项目目前是**空数据库**，需要执行以下 SQL 迁移才能正常使用。

---

## 📋 必须执行的步骤

### 步骤 1：访问 Supabase SQL Editor

1. 打开：https://supabase.com/dashboard
2. 选择项目：`vcoioqystzyztgrgesjw`
3. 点击左侧 **SQL Editor**
4. 点击 **"New query"**

---

### 步骤 2：执行数据库迁移（按顺序！）

**⚠️ 必须按以下顺序执行，不能跳过！**

#### 1️⃣ 基础表结构（必需）

打开文件：`supabase-schema.sql`

复制全部内容，粘贴到 SQL Editor，点击 **Run**

**包含的表**：
- `medications` - 药品信息
- `medication_logs` - 服药记录

#### 2️⃣ 用户设置表（必需）

打开文件：`supabase-user-settings-schema.sql`

复制全部内容，粘贴到 SQL Editor，点击 **Run**

**包含的表**：
- `user_settings` - 用户设置和偏好

#### 3️⃣ 快照功能（推荐）

打开文件：`supabase_snapshots_migration.sql`

复制全部内容，粘贴到 SQL Editor，点击 **Run**

**包含的表**：
- `snapshots` - 数据快照备份

#### 4️⃣ 实时同步（必需 - 核心功能！）

打开文件：`supabase-realtime-migration.sql`

复制全部内容，粘贴到 SQL Editor，点击 **Run**

**功能**：
- 添加 `updated_at` 字段
- 添加 `device_id` 字段
- 启用 Row Level Security (RLS)
- 创建必要的索引

#### 5️⃣ 存储配置（必需）

打开文件：`supabase-storage-setup.sql`

复制全部内容，粘贴到 SQL Editor，点击 **Run**

**功能**：
- 创建 `avatars` bucket（用户头像）
- 创建 `medication-photos` bucket（药品照片）
- 配置 RLS 策略

---

### 步骤 3：启用 Realtime（必需！）

这是 V251219.43 的核心功能！

1. 在 Supabase Dashboard 中
2. 点击 **Database** → **Replication**
3. 找到以下表并**启用**：
   - ✅ `medications`
   - ✅ `medication_logs`
   - ✅ `user_settings`
   - ✅ `snapshots`（如果执行了步骤 3）

**如何启用**：
- 点击表名旁边的开关
- 确保显示为绿色/已启用状态

---

### 步骤 4：验证设置

#### 4.1 检查表是否创建

在 SQL Editor 执行：

```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public'
ORDER BY table_name;
```

**应该看到**：
- medications
- medication_logs
- user_settings
- snapshots
- (其他系统表)

#### 4.2 检查 Storage Buckets

1. 点击左侧 **Storage**
2. 应该看到：
   - `avatars`
   - `medication-photos`

#### 4.3 检查 Realtime

1. 点击 **Database** → **Replication**
2. 确认以下表已启用：
   - medications ✅
   - medication_logs ✅
   - user_settings ✅

---

## 🧪 测试应用

### 本地测试

```bash
npm run dev
```

访问：`http://localhost:5173/meds/`

### 生产环境测试

等待 GitHub Pages 部署完成（约 2-5 分钟）

访问：`https://sevenoy.github.io/meds/`

---

## ✅ 测试清单

完成数据库迁移后，测试以下功能：

### 基础功能
- [ ] 可以注册新账号
- [ ] 可以登录
- [ ] 可以添加药品
- [ ] 可以编辑药品
- [ ] 可以删除药品

### 服药记录
- [ ] 可以添加服药记录
- [ ] 可以拍照上传
- [ ] 可以查看历史记录

### 用户设置
- [ ] 可以上传头像
- [ ] 可以修改设置
- [ ] 头像正常显示

### 多设备实时同步（核心功能！）
- [ ] 同步状态显示 🟢 已连接
- [ ] 在设备 A 添加药品，设备 B 自动显示（1-2秒内）
- [ ] 在设备 B 编辑药品，设备 A 自动更新
- [ ] 删除操作正常同步
- [ ] 断网后重连正常

---

## 🚨 常见问题

### 问题 1：登录失败 "Invalid login credentials"

**原因**：新项目没有用户数据

**解决**：
1. 点击 "没有账号？去注册"
2. 注册新账号
3. 使用新账号登录

### 问题 2：Realtime 不工作

**症状**：同步状态显示 🔴 未连接

**解决**：
1. 确认已执行步骤 2 的第 4 步（实时同步迁移）
2. 确认已执行步骤 3（启用 Realtime）
3. 刷新浏览器页面

### 问题 3：无法上传照片

**原因**：Storage 未配置

**解决**：
1. 确认已执行步骤 2 的第 5 步（存储配置）
2. 检查 Storage 中是否有 buckets
3. 检查 RLS 策略是否正确

### 问题 4：SQL 执行失败

**解决**：
1. 检查是否按顺序执行
2. 查看错误信息
3. 确认没有遗漏步骤
4. 如果某个步骤失败，先解决该步骤再继续

---

## 📊 执行进度跟踪

复制以下清单，执行时打勾：

```
数据库迁移：
- [ ] 1️⃣ 基础表结构 (supabase-schema.sql)
- [ ] 2️⃣ 用户设置表 (supabase-user-settings-schema.sql)
- [ ] 3️⃣ 快照功能 (supabase_snapshots_migration.sql)
- [ ] 4️⃣ 实时同步 (supabase-realtime-migration.sql)
- [ ] 5️⃣ 存储配置 (supabase-storage-setup.sql)

Realtime 启用：
- [ ] medications
- [ ] medication_logs
- [ ] user_settings
- [ ] snapshots

验证：
- [ ] 表已创建
- [ ] Storage buckets 已创建
- [ ] Realtime 已启用
- [ ] 本地测试通过
- [ ] 生产环境测试通过
```

---

## 🎯 预计时间

- **数据库迁移**：10-15 分钟
- **Realtime 启用**：2 分钟
- **验证测试**：5-10 分钟
- **总计**：约 20-30 分钟

---

## 💡 提示

1. **保存数据库密码**
   - 创建项目时设置的密码
   - 以后可能需要用于备份/恢复

2. **备份 SQL 文件**
   - 所有迁移文件都在项目根目录
   - 建议保存一份副本

3. **测试账号**
   - 建议先创建测试账号
   - 测试所有功能后再使用正式账号

4. **多设备测试**
   - 在手机和电脑上同时登录
   - 验证实时同步功能

---

## 🔗 相关文档

- `创建新Supabase项目指南.md` - 详细的项目创建指南
- `REALTIME_SETUP_GUIDE.md` - Realtime 功能详细说明
- `本地测试指南.md` - 完整的测试流程

---

## ✅ 完成后

当所有步骤都完成并测试通过后：

1. **删除旧项目的引用**（可选）
   - 旧项目：`ptmgncjechjprxtndqon`
   - 已无法访问

2. **更新文档**（可选）
   - 更新 README 中的项目信息

3. **通知团队成员**（如有）
   - 告知新的项目 URL
   - 需要重新注册账号

---

**现在请按照步骤 2 执行数据库迁移！** 🚀

完成后应用就可以正常使用了！

