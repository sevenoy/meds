# 🧪 多设备同步测试指南 V260105.07

## 🎯 重要变更

**V260105.07 已禁用默认药品初始化!**

### 为什么要禁用?

**之前的问题:**
- 手机端和电脑端各自初始化 "降压药、降糖药、钙片"
- 看起来像是同步成功了
- **实际上只是碰巧都有相同的默认药品!**

**现在的行为:**
- ✅ 新设备首次打开显示 "暂无药品"
- ✅ 用户需要手动添加药品
- ✅ 这样才能**真正测试多设备同步功能**

---

## 🚀 完整测试步骤

### 准备工作

**所有设备 (手机、电脑、平板):**

1. 清除缓存
   - 进入 "我的" 页面
   - 点击 "清除缓存"
   - 等待刷新

2. 确认版本号
   - 首页顶部应显示: **V260105.07**
   - 如果不是,重新清除缓存

3. 清空所有数据
   - 进入 "我的" 页面
   - 点击 "清除所有药品" (红色按钮)
   - 确认两次删除
   - 查看控制台:
     ```
     ✅ 本地数据库已清空
     ✅ 云端数据已清空
     ✅ Supabase 数据已清空
     ```

4. 刷新页面
   - 所有设备都应该显示 "暂无药品"
   - 数据诊断显示: 0 个药品, 0 条记录

---

## 🧪 测试1: 药品同步

### 设备A (电脑端)

1. 进入 "我的" → "药品管理"

2. 添加第一个药品:
   - 名称: **测试药品A**
   - 剂量: 1片
   - 时间: 08:00
   - 颜色: 任意
   - 点击 "添加药品"

3. 查看控制台:
   ```
   ✅ 新药品已成功写入 payload 并同步到云端
   ✅ 新药品已同步到 Supabase
   🔄 开始加载数据...
   ☁️ 从云端拉取最新数据...
   📥 从云端拉取到 0 条服药记录
   ✅ 云端数据已同步到本地
   📋 已加载 1 个药物: ['测试药品A']
   ```

4. 首页应该显示 "测试药品A"

---

### 设备B (手机端) - 自动同步测试

**不要手动刷新,等待自动同步!**

1. 观察屏幕 (不操作)

2. **1-2秒内**应该:
   - 右上角显示绿色通知: "✅ 药品数据已同步"
   - 首页自动显示 "测试药品A"

3. 查看控制台:
   ```
   [Realtime] 药品变更 {eventType: "INSERT"}
   🔔 检测到药品变更,从云端重新加载...
   📥 从云端拉取到 0 条服药记录
   ✅ 云端数据已同步到本地
   📋 已加载 1 个药物: ['测试药品A']
   ```

**预期结果:**
- ✅ 手机端自动显示 "测试药品A"
- ✅ 无需手动刷新

**如果失败:**
- ❌ 手机端仍显示 "暂无药品"
- 说明 Realtime 同步有问题
- 继续下面的手动刷新测试

---

### 设备B (手机端) - 手动刷新测试

**如果自动同步失败,尝试手动刷新:**

1. 刷新页面 (下拉刷新或重新打开)

2. 查看控制台:
   ```
   🔄 开始加载数据...
   ☁️ 从云端拉取最新数据...
   📥 从云端拉取到 0 条服药记录
   ✅ 云端数据已同步到本地
   📋 已加载 1 个药物: ['测试药品A']
   ```

3. 数据诊断:
   ```
   本地数据库: 1 个药品, 0 条记录
   Payload: 0 个药品, 0 条记录
   当前显示: 1 个药品, 0 条记录
   ```

**预期结果:**
- ✅ 手机端显示 "测试药品A"
- ✅ 药品名称、剂量、时间都正确

**如果还是失败:**
- ❌ 手机端显示 "暂无药品"
- 说明数据根本没有同步到 Supabase
- 需要检查 `pushLocalChanges()` 是否正常

---

### 设备C (平板) - 验证一致性

1. 打开应用
2. 刷新页面
3. 应该也显示 "测试药品A"

**预期结果:**
- ✅ 所有设备显示相同的药品

---

## 🧪 测试2: 服药记录同步

### 设备A (电脑端)

1. 点击 "测试药品A" 的拍照按钮

2. 上传一张照片

3. 完成记录

4. 查看控制台:
   ```
   📸 开始上传图片...
   ✅ 图片上传成功
   📝 创建记录
   💾 记录已保存到本地数据库
   ✅ 记录已同步到 Supabase
   ```

5. "测试药品A" 应该显示绿色对勾 (已完成)

---

### 设备B (手机端) - 自动同步测试

**不要手动刷新,等待自动同步!**

1. 观察屏幕

2. **1-2秒内**应该:
   - 右上角显示蓝色通知: "✅ 服药记录已同步"
   - "测试药品A" 自动显示绿色对勾

3. 查看控制台:
   ```
   [Realtime] 服药记录变更 {eventType: "INSERT"}
   🔔 检测到服药记录变更,从云端重新加载...
   📥 从云端拉取到 1 条服药记录
   ✅ 云端数据已同步到本地
   ```

**预期结果:**
- ✅ 手机端自动显示服药记录
- ✅ "测试药品A" 显示绿色对勾

---

### 手动刷新测试

**如果自动同步失败:**

1. 刷新页面

2. 查看控制台:
   ```
   📥 从云端拉取到 1 条服药记录
   📋 已加载 1 个药物: ['测试药品A']
   ```

3. 数据诊断:
   ```
   本地数据库: 1 个药品, 1 条记录
   当前显示: 1 个药品, 1 条记录
   ```

**预期结果:**
- ✅ 手机端显示服药记录

---

## 🧪 测试3: 编辑和删除同步

### 编辑药品 (设备A)

1. 进入 "我的" → "药品管理"
2. 点击 "测试药品A" 的编辑按钮
3. 修改名称为: **测试药品A-已修改**
4. 点击 "保存"

**设备B:**
- 1-2秒内自动更新为 "测试药品A-已修改"

---

### 删除药品 (设备A)

1. 进入 "我的" → "药品管理"
2. 点击 "测试药品A-已修改" 的删除按钮
3. 确认删除

**设备B:**
- 1-2秒内药品自动消失

---

## 📊 测试结果判断

### ✅ 完全成功

**所有测试都通过:**
- ✅ 添加药品 → 自动同步
- ✅ 添加记录 → 自动同步
- ✅ 编辑药品 → 自动同步
- ✅ 删除药品 → 自动同步
- ✅ 所有设备数据一致

**恭喜!多设备实时同步完美工作!** 🎉

---

### ⚠️ 部分成功 (手动刷新可以同步)

**自动同步失败,但手动刷新成功:**
- ✅ 数据已保存到 Supabase
- ❌ Realtime 推送不工作
- ✅ 手动刷新可以获取最新数据

**问题:**
- Realtime 连接有问题
- 检查控制台是否显示 "connected"

**临时解决方案:**
- 使用手动刷新
- 或者定期自动刷新

---

### ❌ 完全失败 (手动刷新也不行)

**手动刷新也看不到数据:**
- ❌ 数据没有保存到 Supabase
- ❌ `pushLocalChanges()` 失败
- ❌ 或 `pullRemoteChanges()` 失败

**需要检查:**
1. 网络连接
2. Supabase 权限
3. user_id 是否一致
4. 控制台错误信息

---

## 🔍 故障排查

### 检查1: user_id 是否一致

**所有设备控制台执行:**
```javascript
const module = await import('./src/lib/supabase.js');
const userId = await module.getCurrentUserId();
console.log('当前 user_id:', userId);
```

**应该相同!**

如果不同:
- 说明登录了不同账号
- 数据被 RLS 隔离

---

### 检查2: Realtime 连接状态

**所有设备控制台:**
- 搜索 "Realtime 连接状态"
- 应该显示: `connected`

如果是 `disconnected`:
- Realtime 服务有问题
- 检查 Supabase Realtime 是否启用

---

### 检查3: Supabase 数据

**SQL 查询:**
```sql
SELECT id, name, user_id, device_id 
FROM medications 
WHERE user_id = 'YOUR_USER_ID';
```

**应该显示:**
- 设备A添加的药品

如果没有:
- `pushLocalChanges()` 失败
- 查看控制台错误

---

### 检查4: 控制台错误

**搜索关键词:**
- "失败"
- "error"
- "ERROR"
- "❌"

**常见错误:**
- 网络请求失败
- 权限被拒绝
- medication_id 不是 UUID

---

## 📝 测试记录模板

### 测试环境

- **设备A**: 电脑 / Chrome
- **设备B**: 手机 / Safari
- **设备C**: 平板 / Chrome
- **版本号**: V260105.07
- **测试时间**: 2026-01-05

### 测试结果

| 测试项 | 设备A → 设备B | 设备B → 设备A | 结果 |
|--------|---------------|---------------|------|
| 添加药品 (自动) | ☐ 成功 ☐ 失败 | ☐ 成功 ☐ 失败 | ☐ 通过 ☐ 失败 |
| 添加药品 (手动) | ☐ 成功 ☐ 失败 | ☐ 成功 ☐ 失败 | ☐ 通过 ☐ 失败 |
| 添加记录 (自动) | ☐ 成功 ☐ 失败 | ☐ 成功 ☐ 失败 | ☐ 通过 ☐ 失败 |
| 添加记录 (手动) | ☐ 成功 ☐ 失败 | ☐ 成功 ☐ 失败 | ☐ 通过 ☐ 失败 |
| 编辑药品 | ☐ 成功 ☐ 失败 | ☐ 成功 ☐ 失败 | ☐ 通过 ☐ 失败 |
| 删除药品 | ☐ 成功 ☐ 失败 | ☐ 成功 ☐ 失败 | ☐ 通过 ☐ 失败 |

### 问题记录

- [ ] 问题1: ___________________
- [ ] 问题2: ___________________
- [ ] 问题3: ___________________

### 控制台截图

- [ ] 设备A - 添加药品后的日志
- [ ] 设备B - 接收同步后的日志
- [ ] 数据诊断报告

---

## 🎯 下一步

1. **立即测试:**
   - 清空所有数据
   - 按照测试步骤操作
   - 记录结果

2. **反馈结果:**
   - 哪些测试通过了?
   - 哪些测试失败了?
   - 控制台有什么错误?

3. **提供信息:**
   - 数据诊断报告截图
   - 控制台日志截图
   - 测试记录表

---

**现在开始测试!祝测试顺利!** 🚀

---

© 2026 药盒助手 V260105.07 | 多设备同步测试版本



