# 多设备同步测试文档

## 🔄 同步机制概述

本应用使用 **Supabase Realtime + 定时轮询** 的双重同步机制，确保多设备之间的数据快速同步。

### 同步机制

1. **Realtime 实时推送**（主要）
   - 监听 `medications` 表变化
   - 监听 `medication_logs` 表变化  
   - 监听 `user_settings` 表变化
   - 延迟：< 1 秒

2. **定时轮询同步**（备用）
   - 每 3 秒自动同步一次
   - 确保 Realtime 失败时也能同步
   - 延迟：≤ 3 秒

### 同步内容

- ✅ **药品列表** - medications 表
- ✅ **服药记录** - medication_logs 表
- ✅ **用户头像** - user_settings.avatar_url
- ✅ **其他设置** - user_settings.*

---

## 📋 测试前准备

### 1. 确保 Supabase 配置正确

检查 Supabase Realtime 是否启用：

1. 登录 Supabase Dashboard
2. 进入 Database → Replication
3. 确保以下表启用了 Realtime：
   - `medications` ✅
   - `medication_logs` ✅
   - `user_settings` ✅

### 2. 准备测试设备

- **设备A**: 电脑/手机1
- **设备B**: 手机2/另一台电脑
- 确保两台设备登录**同一账号**

### 3. 打开浏览器控制台

在两台设备上都打开控制台（F12），观察同步日志。

---

## 🧪 测试场景

### 场景1：添加新药品（设备A → 设备B）

#### 操作步骤：

1. **在设备A上**：
   - 点击右下角的"+"按钮
   - 添加新药品（例如："阿莫西林 500mg 08:00"）
   - 点击保存

2. **观察设备A控制台**：
   ```
   ✅ 药品已添加
   📤 正在同步medications...
   ✅ Medications同步完成
   ```

3. **观察设备B（等待 1-3 秒）**：
   ```
   📥 Realtime: medications变化 INSERT
   💊 检测到药品列表更新
   🔔 收到药品列表更新，自动同步...
   ✅ 药品列表已自动同步
   ```

4. **验证设备B**：
   - 右上角显示绿色提示："✅ 药品列表已从其他设备同步"
   - 新药品自动出现在列表中
   - 无需手动刷新

#### 预期结果：

- ✅ 设备B 在 **1-3 秒内**自动显示新药品
- ✅ 显示绿色提示通知
- ✅ 提示 3 秒后自动消失

---

### 场景2：修改用户头像（设备A → 设备B）

#### 操作步骤：

1. **在设备A上**：
   - 切换到"我的"页面
   - 点击右上角编辑按钮
   - 上传新头像
   - 等待上传完成

2. **观察设备A控制台**：
   ```
   ☁️ 上传头像到: <user-id>/<timestamp>.jpg
   ✅ 头像上传成功
   📤 正在推送用户设置到云端...
   ✅ 推送成功，云端数据已更新
   📡 Realtime将自动推送到其他设备...
   ```

3. **观察设备B（等待 1-3 秒）**：
   ```
   📥 收到用户设置更新: UPDATE
   🔔 检测到设置更新，自动应用...
   👤 检测到头像更新，自动同步...
   ✅ 设置已自动更新
   ```

4. **验证设备B**：
   - 右上角显示黑色提示："✅ 头像已从其他设备同步"
   - 用户信息卡片中的头像自动更新
   - 编辑弹窗中的头像也更新
   - 无需刷新页面

#### 预期结果：

- ✅ 设备B 在 **1-3 秒内**自动更新头像
- ✅ 显示黑色提示通知
- ✅ 所有显示头像的地方都自动更新

---

### 场景3：记录服药（设备A → 设备B）

#### 操作步骤：

1. **在设备A上**：
   - 点击某个药品的相机按钮
   - 拍照或上传照片
   - 确认记录

2. **观察设备A控制台**：
   ```
   📸 正在上传照片...
   ✅ 服药记录已保存
   📤 正在同步medication_logs...
   ```

3. **观察设备B（等待 1-3 秒）**：
   ```
   📥 Realtime: medication_logs变化 INSERT
   📱 检测到其他设备的服药记录
   🔔 收到其他设备的服药记录更新
   ✅ 服药记录已自动同步
   ```

4. **验证设备B**：
   - 药品状态自动变为"已完成"（绿色对勾）
   - "时间轴"页面显示新记录
   - 今日完成进度自动更新

#### 预期结果：

- ✅ 设备B 在 **1-3 秒内**自动更新服药状态
- ✅ 药品卡片显示绿色对勾
- ✅ 时间轴显示新记录

---

### 场景4：删除药品（设备A → 设备B）

#### 操作步骤：

1. **在设备A上**：
   - 长按某个药品
   - 点击删除按钮
   - 确认删除

2. **观察设备A控制台**：
   ```
   🗑️ 正在删除药品...
   ✅ 药品已删除
   📤 正在同步medications...
   ```

3. **观察设备B（等待 1-3 秒）**：
   ```
   📥 Realtime: medications变化 DELETE
   💊 检测到药品列表更新
   🔔 收到药品列表更新，自动同步...
   ✅ 药品列表已自动同步
   ```

4. **验证设备B**：
   - 被删除的药品自动从列表中消失
   - 显示绿色提示通知

#### 预期结果：

- ✅ 设备B 在 **1-3 秒内**自动移除药品
- ✅ 显示绿色提示通知

---

## 🔍 故障排查

### 问题1：设备B没有自动同步

#### 检查步骤：

1. **检查网络连接**
   - 确保设备B有网络
   - 尝试刷新页面

2. **检查 Realtime 订阅状态**
   
   在设备B控制台查找：
   ```
   ✅ 药品数据 Realtime 订阅成功
   ✅ 用户设置 Realtime 订阅成功
   ```
   
   如果看到：
   ```
   ❌ ... Realtime 订阅失败
   ```
   
   则需要检查 Supabase 配置。

3. **检查登录状态**
   
   确保两台设备登录的是同一账号：
   ```javascript
   // 在控制台执行
   console.log('User ID:', localStorage.getItem('userId'));
   ```
   
   两台设备的 User ID 应该相同。

4. **检查定时同步**
   
   即使 Realtime 失败，定时同步也应该工作：
   ```
   ⏰ 定时同步...
   📥 拉取到 X 条新记录
   🔄 数据已变化，刷新界面...
   ```
   
   如果看到这些日志，说明数据会在 3 秒内同步。

---

### 问题2：同步延迟过长（> 5秒）

#### 可能原因：

1. **网络延迟**
   - 检查网络速度
   - 尝试使用更好的网络环境

2. **Supabase 服务器延迟**
   - 检查 Supabase Dashboard 是否有报警
   - 查看服务器区域是否离您较远

3. **浏览器节流**
   - 某些浏览器会节流后台标签页
   - 确保设备B的应用标签页在前台

#### 解决方法：

1. **强制刷新**
   - 在设备B上点击顶部的刷新按钮
   - 或使用 Ctrl+R / Cmd+R 刷新

2. **查看定时同步**
   - 定时同步每 3 秒执行一次
   - 最多等待 3 秒即可看到更新

---

### 问题3：Realtime 订阅失败

#### 检查 Supabase 配置：

1. **Realtime 是否启用**
   
   Supabase Dashboard → Database → Replication
   
   确保以下表启用了 Realtime：
   - `medications`
   - `medication_logs`
   - `user_settings`

2. **RLS 策略是否正确**
   
   ```sql
   -- medications 表
   CREATE POLICY "用户可以查看自己的药品"
   ON medications FOR SELECT
   USING (auth.uid() = user_id);
   
   -- medication_logs 表
   CREATE POLICY "用户可以查看自己的服药记录"
   ON medication_logs FOR SELECT
   USING (auth.uid() = user_id);
   
   -- user_settings 表
   CREATE POLICY "用户可以查看自己的设置"
   ON user_settings FOR SELECT
   USING (auth.uid() = user_id);
   ```

3. **API 密钥是否正确**
   
   检查代码中的 Supabase URL 和 Anon Key 是否正确。

---

## 📊 同步性能指标

### 正常情况：

- **Realtime 延迟**: < 1 秒
- **定时同步间隔**: 3 秒
- **总同步延迟**: 1-3 秒

### 最坏情况（Realtime 失败）：

- **定时同步延迟**: ≤ 3 秒
- **可靠性**: 99%+

---

## ✅ 测试检查清单

在推送到生产环境前，确保完成以下测试：

- [ ] 场景1：添加新药品 - 设备B自动显示
- [ ] 场景2：修改头像 - 设备B自动更新
- [ ] 场景3：记录服药 - 设备B自动更新状态
- [ ] 场景4：删除药品 - 设备B自动移除
- [ ] Realtime 订阅状态为 SUBSCRIBED
- [ ] 定时同步日志正常输出
- [ ] 同步延迟 < 3 秒
- [ ] 提示通知正常显示
- [ ] 不同浏览器测试通过
- [ ] 手机端测试通过

---

## 🎯 优化建议

### 当前实现：

- ✅ Realtime 实时推送
- ✅ 定时轮询备用
- ✅ 自动合并冲突
- ✅ 友好提示通知
- ✅ 详细的日志输出

### 可能的优化：

1. **减少定时同步间隔** - 从 3 秒减少到 2 秒（需权衡性能）
2. **增加重试机制** - Realtime 失败时自动重连
3. **离线队列** - 离线时缓存操作，联网后批量同步
4. **增量同步** - 只同步变化的数据，减少流量

---

**文档版本**: V251219.8  
**最后更新**: 2025年12月19日  
**维护者**: AI Assistant
