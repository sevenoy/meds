# ⚡ 立即执行 - 两步修复

## 问题确认 ✅

- 版本号错误: `V260103.01` → 应为 `V260105.10`
- 数据库错误: 缺少 `device_id` 列
- 认证正常: ✅ 用户 `sevenoy@gmail.com` 已登录

---

## 第一步: 修复数据库 (2分钟)

### ⚠️ 重要: 只复制 SQL 代码,不要复制 Markdown 标题!

### 操作:
1. 打开 https://supabase.com/dashboard
2. 选择你的项目
3. 点击左侧 **SQL Editor**
4. 点击 **New Query**
5. **只复制下面的 SQL 代码** (不包括 \`\`\`sql 标记):

```sql
ALTER TABLE public.medications ADD COLUMN IF NOT EXISTS device_id text;
ALTER TABLE public.medication_logs ADD COLUMN IF NOT EXISTS device_id text;
CREATE INDEX IF NOT EXISTS idx_medications_device_id ON public.medications(device_id);
CREATE INDEX IF NOT EXISTS idx_medication_logs_device_id ON public.medication_logs(device_id);
NOTIFY pgrst, 'reload schema';
```

💡 **提示**: 也可以打开项目中的 `SQL_修复脚本.sql` 文件复制

6. 点击 **Run** 或按 `Ctrl+Enter`
7. 看到 `Success. No rows returned` 即成功

---

## 第二步: 清除浏览器缓存 (1分钟)

### 操作:
1. 打开你的应用: https://sevenoy.github.io/meds/
2. 按 `F12` 打开控制台
3. 切换到 **Console** 标签
4. **复制下面的代码** (不包括 \`\`\`javascript 标记):

```javascript
(async()=>{console.log('🧹 清理中...');if('serviceWorker'in navigator){const r=await navigator.serviceWorker.getRegistrations();for(const reg of r)await reg.unregister();}if('caches'in window){const n=await caches.keys();for(const name of n)await caches.delete(name);}localStorage.clear();sessionStorage.clear();if(window.indexedDB){const dbs=await indexedDB.databases();for(const db of dbs)indexedDB.deleteDatabase(db.name);}console.log('✅ 完成! 3秒后刷新');setTimeout(()=>window.location.reload(true),3000);})();
```

💡 **提示**: 也可以打开项目中的 `清除缓存脚本.js` 文件复制

5. 按 `Enter` 执行
6. 等待 3 秒,页面自动刷新

---

## ✅ 验证成功

刷新后,控制台应显示:

```
📦 当前版本: V260105.10
✅ Service Worker 注册成功
✅ 云端数据已加载并初始化 payload
🔗 Realtime 连接状态变更: connected
```

### 不应再出现:
- ❌ `V260103.01` (旧版本号)
- ❌ `Could not find the 'device_id' column`
- ❌ `系统未初始化`
- ❌ `用户未登录`

---

## 🎯 测试多设备同步

1. 打开两个设备/浏览器窗口
2. 设备 A: 添加一个药品
3. 设备 B: 1-2秒内自动显示新药品 ✅
4. 设备 A: 添加一条服药记录
5. 设备 B: 1-2秒内自动显示记录 ✅

看到控制台消息:
```
🔔 检测到药品变更（新Realtime），从云端重新加载...
```

---

## ⚠️ 如果还有问题

### 如果版本号还是 V260103.01:
- 使用**无痕模式/隐私模式**打开应用
- 或尝试不同的浏览器

### 如果还有 device_id 错误:
- 确认 SQL 执行成功
- 再次执行 `NOTIFY pgrst, 'reload schema';`
- 等待 30 秒后刷新

### 如果页面卡住不动:
- 检查是否有大量测试数据
- 在控制台执行:
  ```javascript
  localStorage.clear();
  location.reload();
  ```

