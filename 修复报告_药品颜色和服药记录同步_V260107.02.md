# 修复报告：药品颜色主题和服药记录同步

## 修复日期
2026-01-07

## 修复内容

### A) 药品颜色主题即时同步修复

#### 问题描述
- 药品颜色主题修改后不即时同步（本机/他机都不生效）
- 颜色字段 `accent` 在写入时被 `sanitizeMedicationForDb` 删除

#### 修复措施

1. **修复 `sanitizeMedicationForDb` 函数**
   - 文件：`src/services/cloudOnly.ts`
   - 修改：将 `accent` 字段加入数据库白名单，不再删除
   - 确保颜色值能正确写入数据库

2. **修复写入后立即更新本地 state**
   - 文件：`App.tsx`, `src/components/MedicationManagePage.tsx`
   - 修改：在 `upsertMedicationToCloud` 成功后，立即用返回数据更新本地 state
   - 确保本机立即生效，不等待 Realtime

3. **修复 medications Realtime 回调**
   - 文件：`App.tsx`
   - 修改：禁止 payload patch，改为全量替换
   - 回调中调用 `getMedicationsFromCloud()` 全量拉取并替换
   - 添加日志：打印 eventType、id、commit_timestamp、count、max(updated_at)

4. **数据库迁移**
   - 文件：`supabase-add-accent-field.sql`
   - 添加 `accent` 字段到 `medications` 表
   - 为现有药品设置默认颜色

#### 验收标准
- ✅ 设备A改颜色：A 立刻变；B 1-2 秒内变（不刷新）
- ✅ 本机 label、小圆点颜色即时变化
- ✅ 控制台可看到 meds realtime 回调 + reload 完成日志

---

### B) 服药记录 1条 -> 4条 分阶段出现修复

#### 问题描述
- 新设备首次打开：logs 数量从 1 条逐渐变成 4 条（分阶段出现）
- 根因：`loadDataFast` 先加载今日记录，然后 `loadData` 后台加载完整数据并 merge

#### 修复措施

1. **移除分阶段加载逻辑**
   - 文件：`App.tsx`
   - 修改：移除 `loadDataFast()` 调用，改为单步全量加载
   - 初始化流程：只调用一次 `loadData(true, 'app-init')`，全量拉取并替换

2. **修复 logs Realtime 回调**
   - 文件：`App.tsx`
   - 修改：禁止 payload patch，改为全量替换
   - 回调中调用 `getLogsFromCloud()` 全量拉取并替换
   - 添加去抖：500ms 内多事件只 reload 一次

3. **添加诊断日志**
   - 文件：`App.tsx`
   - 修改：在 `safeSetTimelineLogs` 中打印调用来源
   - 在 `onLogChange` 回调中打印：eventType、id、commit_timestamp
   - 在 reload 完成时打印：count、min/max taken_at、max(uploaded_at)

#### 根因分析

**为何之前仍 1->4？**

1. **初始化流程问题**：
   ```typescript
   // 旧代码（已修复）
   loadDataFast(); // 先加载今日记录（1条）
   // 后台
   loadData(true, 'app-init-background'); // 再加载完整数据（4条）并 merge
   ```
   - `loadDataFast` 先设置 `setTimelineLogs(todayLogs)` → 显示 1 条
   - `loadData` 后台加载完整数据并 merge → 显示 4 条
   - 导致用户看到数量从 1 变成 4

2. **修复后**：
   ```typescript
   // 新代码
   await loadData(true, 'app-init'); // 单步全量加载，一次性稳定
   ```
   - 只调用一次全量加载
   - 数量一次性稳定，不再分阶段出现

#### 验收标准
- ✅ 新设备首次打开：logs 数量一次性稳定（不再 1->4）
- ✅ 刷新：数量不跳变
- ✅ 设备A新增记录：B 1-2 秒出现（不刷新）
- ✅ 弱网/断网后恢复：能自动 reload 对齐

---

## 修改文件清单

1. **src/services/cloudOnly.ts**
   - 修复 `sanitizeMedicationForDb`：保留 `accent` 字段
   - 修复 `onMedicationChange`：改为全量替换

2. **App.tsx**
   - 修复初始化流程：移除 `loadDataFast`，改为单步全量加载
   - 修复 `onMedicationChange`：改为全量替换，添加日志
   - 修复 `onLogChange`：改为全量替换，添加去抖（500ms）
   - 修复编辑药品：写入成功后立即更新本地 state（包括颜色）
   - 添加 `logDebounceTimerRef`：用于 logs Realtime 去抖

3. **src/components/MedicationManagePage.tsx**
   - 修复编辑药品：写入成功后立即更新本地 state（包括颜色）

4. **supabase-add-accent-field.sql**（新建）
   - 数据库迁移：添加 `accent` 字段到 `medications` 表

---

## 验收日志示例

### 药品颜色同步日志
```
✅ 药品已直接更新到云端: 降压药 { accent: '#FFD1DC' }
✅ [修复A] 本机 state 已立即更新（包括颜色）: #FFD1DC
🔔 [Realtime] 药品变更: eventType=UPDATE, id=xxx, commit_timestamp=2026-01-07T...
📥 [Realtime] 全量拉取 medications: 3 条
✅ [Realtime] medications 全量替换完成: count=3, max(updated_at)=2026-01-07T...
```

### 服药记录同步日志
```
🔔 [Realtime] 服药记录变更: eventType=INSERT, id=xxx, commit_timestamp=2026-01-07T...
📥 [Realtime] 开始全量拉取 logs（去抖后）
✅ [Realtime] logs 全量替换完成: count=4, min(taken_at)=2026-01-01T..., max(taken_at)=2026-01-07T..., max(uploaded_at)=2026-01-07T...
📊 [setTimelineLogs] 来源: realtime-log-insert-reload, 数量: 3 → 4, 耗时: 15.23ms
```

### 初始化日志（修复后）
```
📥 [初始化] 开始全量加载数据（单步，禁止分阶段）
☁️ [初始化] 从云端拉取 medications（唯一拉取点）
☁️ [初始化] 从云端拉取 logs（唯一拉取点，瘦身版本）
📝 [初始化] 从云端加载 4 条服药记录（渲染前 logs 条数: 4）
✅ [初始化] 全量数据加载完成，数量一次性稳定
📊 [setTimelineLogs] 来源: app-init, 数量: 0 → 4, 耗时: 45.67ms
```

---

## 数据库迁移步骤

1. 在 Supabase Dashboard 中执行 SQL：
   ```sql
   -- 执行 supabase-add-accent-field.sql
   ```

2. 验证字段已添加：
   ```sql
   SELECT column_name, data_type 
   FROM information_schema.columns 
   WHERE table_name = 'medications' AND column_name = 'accent';
   ```

---

## 注意事项

1. **数据库迁移必须执行**：否则 `accent` 字段无法写入数据库
2. **颜色值格式**：支持 hex 颜色（如 `#E0F3A2`）或预设值（如 `lime`、`berry`、`mint`）
3. **去抖时间**：logs Realtime 去抖时间为 500ms，可根据实际情况调整（300-800ms）
4. **性能优化**：全量替换可能带来性能开销，但确保了数据一致性

---

## 版本信息

- 修复版本：V260107.02
- 修复日期：2026-01-07
- 修复工程师：AI Assistant

